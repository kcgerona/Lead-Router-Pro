
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Survey - Lead Router Pro</title>
    <style>
        /* Reset and Base Styles - Scoped to widget container */
        #vendor-survey-widget * {
            box-sizing: border-box;
        }
        
        #vendor-survey-widget {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
        }

        /* WordPress compatibility - remove body styles */

        /* Modal Container */
        #vendor-survey-widget {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            /* Ensure proper sizing in iframes */
            min-height: 500px;
            position: relative;
        }
        
        /* Ensure body has no margin when in iframe */
        body {
            margin: 0;
            padding: 0;
            /* Allow scrolling if needed */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Header */
        .modal-header {
            background: #4573a8;
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding-bottom: 35px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .header-logo {
            height: 40px;
            width: auto;
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 0;
            flex: 1;
            text-align: center;
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .close-button:hover {
            opacity: 1;
        }

        /* Rope Separator */
        .rope-separator {
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100%;
            height: 14px;
            background-color: transparent;
            background-image: url('https://dockside.life/static/DSP%20Rope.png');
            background-repeat: repeat-x;
            background-position: center;
            background-size: auto 14px;
            pointer-events: none;
            z-index: 10;
        }

        /* Fallback rope pattern if image doesn't load */
        .rope-separator:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 0;
            right: 0;
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                #D4B896 0px,
                #C4A886 2px,
                #B8985F 4px,
                #D4B896 6px
            );
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Show fallback only when image fails to load */
        .rope-separator:not([style*="background-image"]):after {
            opacity: 1;
        }

        /* Progress Bar */
        .progress-container {
            background: #e0e0e0;
            height: 35px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            background: #4573a8;
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Content Area */
        .modal-content {
            background: #f9f6f2;
            padding: 40px;
            min-height: 400px;
            position: relative;
        }

        /* Slide Container */
        .form-slide {
            display: none;
        }

        .form-slide.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Typography */
        .slide-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .slide-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="url"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4573a8;
            box-shadow: 0 0 0 3px rgba(69, 115, 168, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Service Selection Styles */
        .service-tag {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: #e3edfd;
            color: #2c5282;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .service-tag:hover {
            background: #c5d9f2;
        }

        .service-tag.selected {
            background: #4573a8;
            color: white;
            border-color: #4573a8;
        }

        /* Level 3 Service Badge */
        .service-count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6600;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: inline-block;
            margin-left: 6px;
        }

        .service-tag.selected .service-count-badge {
            background: #ffcc00;
            color: #333;
        }

        .services-container {
            /* Removed max-height to allow full expansion */
            overflow: visible;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        /* Two-column layout for address */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        /* Navigation Buttons */
        .navigation-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
            gap: 20px;
        }
        
        /* Two-button layout - equal width */
        .navigation-buttons.two-button-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 500px;
            margin: 40px auto 0;
        }
        
        /* Three-button layout - equal width with Clear centered */
        .navigation-buttons.three-button-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 600px;
            margin: 40px auto 0;
        }

        .nav-button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
            text-align: center;
        }
        
        /* Ensure equal sizing in grid layouts */
        .two-button-layout .nav-button,
        .three-button-layout .nav-button {
            width: 100%;
            min-width: unset;
        }

        .nav-button.previous {
            background: #D4B896;
            color: #333;
        }

        .nav-button.previous:hover {
            background: #C4A886;
            transform: translateX(-2px);
        }

        .nav-button.next {
            background: #4573a8;
            color: white;
        }

        .nav-button.next:hover {
            background: #365a89;
            transform: translateX(2px);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Submit Button */
        .submit-button {
            background: #4573a8;
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-button:hover:not(:disabled) {
            background: #365a89;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(69, 115, 168, 0.3);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .submit-button.loading {
            position: relative;
            color: transparent;
        }

        .submit-button.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 4px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 14px;
            line-height: 1.5;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* State/County Selection */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 0 -10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 0;
        }

        /* Selection Controls */
        .selection-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-small:hover {
            background: #f5f5f5;
            border-color: #4573a8;
        }

        #county-loading,
        #county-error {
            padding: 30px;
            text-align: center;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 10px -10px;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        /* Field Error */
        .field-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
        }

        .form-group.has-error input,
        .form-group.has-error textarea,
        .form-group.has-error select {
            border-color: #dc3545;
        }

        /* Category Selection */
        .category-option {
            padding: 12px;
            margin: 8px 0;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-option:hover {
            border-color: #4573a8;
            background: #f0f5ff;
        }

        .category-option.selected {
            border-color: #4573a8;
            background: #e3edfd;
        }

        /* Responsive Design */
        /* Level 3 Services Modal */
        .level3-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .level3-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level3-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .level3-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level3-modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .level3-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level3-modal-close:hover {
            color: #333;
        }

        .level3-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .level3-info-text {
            background: #f0f6fc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #4573a8;
            font-size: 14px;
        }

        .level3-service-list {
            display: grid;
            gap: 10px;
        }

        .level3-service-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .level3-service-item:hover {
            background: #f9f9f9;
            border-color: #4573a8;
        }

        .level3-service-item input[type="checkbox"] {
            margin-right: 12px;
            cursor: pointer;
        }

        .level3-service-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
        }

        .level3-modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e5e5;
            display: flex;
            justify-content: flex-end;
        }

        .level3-done-button {
            padding: 10px 30px;
            background: #4573a8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .level3-done-button:hover {
            background: #365a89;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .header-logo {
                height: 30px;
            }

            .modal-header h2 {
                font-size: 18px;
                text-align: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .navigation-buttons {
                flex-direction: column;
            }

            .nav-button {
                width: 100%;
            }

            .checkbox-grid {
                margin: 0;
                grid-template-columns: 1fr;
            }

            #countyInputGroup,
            #coverage-details {
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        /* Clear Form Button */
        .nav-button.clear {
            background: #dc3545;
            color: white;
            font-size: 14px;
            padding: 8px 16px;
            min-width: 100px;
        }
        
        .nav-button.clear:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div id="vendor-survey-widget">
        <!-- Header -->
        <div class="modal-header">
            <div class="header-content">
                <img src="https://docksidepros.com/wp-content/uploads/2023/06/dock-side-pro-logo-3.png" alt="DockSide Pro" class="header-logo">
                <h2>Apply To Be a Featured Dockside Pro</h2>
            </div>
            <!-- Close button removed - popup window handles closing -->
            <!-- Rope Separator -->
            <div class="rope-separator"></div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <!-- Messages -->
        <div class="message success" id="successMessage"></div>
        <div class="message error" id="errorMessage"></div>

        <!-- Content -->
        <div class="modal-content">
            <form id="vendorSurveyForm">
                <!-- Slide 1: Company Name -->
                <div class="form-slide active" id="slide-1">
                    <h3 class="slide-title">What is Your Company Name?</h3>
                    
                    <div class="form-group">
                        <input type="text" id="vendor_company_name" name="vendor_company_name" placeholder="What is Your Company Name?" required>
                        <span class="field-error"></span>
                    </div>

                    <div class="navigation-buttons">
                        <div></div>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(1)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 2: Company Address -->
                <div class="form-slide" id="slide-2">
                    <h3 class="slide-title">What's Your Current Company Address</h3>
                    
                    <div class="form-row full-width">
                        <div class="form-group">
                            <input type="text" id="address1" name="address1" placeholder="Street" required>
                            <span class="field-error"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="city" name="city" placeholder="City" required>
                            <span class="field-error"></span>
                        </div>
                        <div class="form-group">
                            <select id="state" name="state" required>
                                <option value="">State</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                            <span class="field-error"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="postalCode" name="postalCode" placeholder="Zipcode" required>
                            <span class="field-error"></span>
                        </div>
                        <div></div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(2)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(2)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 3: Personal Information -->
                <div class="form-slide" id="slide-3">
                    <h3 class="slide-title">Your Contact Details</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="firstName" name="firstName" placeholder="First Name" required>
                            <span class="field-error"></span>
                        </div>
                        <div class="form-group">
                            <input type="text" id="lastName" name="lastName" placeholder="Last Name" required>
                            <span class="field-error"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <input type="email" id="email" name="email" placeholder="Email Address" required>
                            <span class="field-error"></span>
                        </div>
                        <div class="form-group">
                            <input type="tel" id="phone" name="phone" placeholder="Phone Number" required>
                            <span class="field-error"></span>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(3)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(3)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 4: Primary Service Category -->
                <div class="form-slide" id="slide-4">
                    <h3 class="slide-title">What Main Service Does Your Company Offer?</h3>
                    
                    <div class="form-group">
                        <select id="primary_service_category" name="primary_service_category" placeholder="Select Your Main Service" required>
                            <option value="">Select Your Main Service</option>
                            <option value="Boat and Yacht Repair">Boat and Yacht Repair</option>
                            <option value="Boat Maintenance">Boat Maintenance</option>
                            <option value="Marine Systems">Marine Systems</option>
                            <option value="Engines and Generators">Engines and Generators</option>
                            <option value="Boat Towing">Boat Towing</option>
                            <option value="Boater Resources">Boater Resources</option>
                            <option value="Buying or Selling a Boat">Buying or Selling a Boat</option>
                            <option value="Docks, Seawalls and Lifts">Docks, Seawalls and Lifts</option>
                            <option value="Dock and Slip Rental">Dock and Slip Rental</option>
                            <option value="Fuel Delivery">Fuel Delivery</option>
                            <option value="Boat Charters and Rentals">Boat Charters and Rentals</option>
                            <option value="Boat Hauling and Yacht Delivery">Boat Hauling and Yacht Delivery</option>
                            <option value="Maritime Education and Training">Maritime Education and Training</option>
                            <option value="Yacht Management">Yacht Management</option>
                            <option value="Waterfront Property">Waterfront Property</option>
                            <option value="Wholesale or Dealer Product Pricing">Wholesale or Dealer Product Pricing</option>
                        </select>
                        <span class="field-error"></span>
                    </div>

                    <div id="primary-services-section" style="display: none;">
                        <p class="slide-subtitle">Select Services Offered</p>
                        <div class="services-container" id="primary-services-container">
                            <!-- Services will be populated dynamically -->
                        </div>
                    </div>

                    <div class="navigation-buttons three-button-layout">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(4)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button clear" onclick="clearCurrentSlideAndAfter()">
                            Clear Form
                        </button>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(4)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 5: Additional Categories -->
                <div class="form-slide" id="slide-5">
                    <h3 class="slide-title">Do You Offer Any Additional Services?</h3>
                    <p class="slide-subtitle">You may select up to 2 additional categories (optional)</p>
                    
                    <div id="additional-categories-container">
                        <!-- Categories will be populated dynamically -->
                    </div>

                    <div class="navigation-buttons three-button-layout">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(5)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button clear" onclick="clearCurrentSlideAndAfter()">
                            Clear Form
                        </button>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(5)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 6: Additional Services (if applicable) -->
                <div class="form-slide" id="slide-6">
                    <h3 class="slide-title">Select Services from Your Additional Categories</h3>
                    
                    <div id="additional-services-container">
                        <!-- Services will be populated dynamically -->
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(6)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(6)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 7: Coverage Area -->
                <div class="form-slide" id="slide-7">
                    <h3 class="slide-title">Where Do You Provide Services?</h3>
                    
                    <div class="form-group">
                        <label for="coverage_type">Coverage Type</label>
                        <select id="coverage_type" name="coverage_type" required>
                            <option value="">Select Coverage Type</option>
                            <option value="global">Global - Worldwide Service</option>
                            <option value="national">National - All United States</option>
                            <option value="state">State - Specific States</option>
                            <option value="county">County - Specific Counties</option>
                            <option value="zip">ZIP Codes - Specific Areas</option>
                        </select>
                        <span class="field-error"></span>
                    </div>

                    <div id="coverage-details" style="display: none; margin: 0 -10px; padding: 0 10px;">
                        <!-- Coverage type specific inputs -->
                        <input type="hidden" id="service_coverage_area" name="service_coverage_area">
                        
                        <!-- State Selection -->
                        <div id="stateSelectionContainer" style="display: none;">
                            <div class="selection-controls">
                                <button type="button" class="btn-small" onclick="selectAllStates()">Select All</button>
                                <button type="button" class="btn-small" onclick="clearAllStates()">Clear All</button>
                                <span id="state-count">0 selected</span>
                            </div>
                            <div class="checkbox-grid" id="state-checkboxes">
                                <!-- State checkboxes will be populated here -->
                            </div>
                        </div>

                        <!-- County Selection -->
                        <div id="countyInputGroup" style="display: none; margin: 0 -10px; padding: 0 10px;">
                            <div class="form-group">
                                <label for="county_state_selector">Select State First</label>
                                <select id="county_state_selector" style="width: 100%;">
                                    <option value="">Select State</option>
                                    <!-- States will be populated -->
                                </select>
                            </div>
                            <div id="county-loading" style="display: none; text-align: center; padding: 30px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; margin: 10px 0;">
                                <div style="color: #666;">Loading counties...</div>
                            </div>
                            <div id="county-checkboxes-container" style="display: none;">
                                <div class="selection-controls">
                                    <span id="county-count">0 counties selected</span>
                                </div>
                                <div class="checkbox-grid" id="county-checkboxes">
                                    <!-- County checkboxes will be populated here -->
                                </div>
                            </div>
                            <div id="county-error" style="display: none; color: #e74c3c; margin-top: 10px; padding: 20px; background: #fee; border: 1px solid #fcc; border-radius: 6px;">
                                Unable to load counties. Please enter them manually in the field below.
                            </div>
                        </div>

                        <!-- ZIP codes -->
                        <div id="zipInputGroup" style="display: none;">
                            <div class="form-group">
                                <label for="service_zip_codes">Enter ZIP Codes (comma-separated)</label>
                                <input type="text" id="service_zip_codes" name="service_zip_codes" placeholder="33101, 33139, 33154">
                            </div>
                        </div>
                    </div>

                    <div class="navigation-buttons three-button-layout">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(7)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button clear" onclick="clearCurrentSlideAndAfter()">
                            Clear Form
                        </button>
                        <button type="button" class="nav-button next" onclick="window.nextSlide(7)">
                            Next <span>→</span>
                        </button>
                    </div>
                </div>

                <!-- Slide 8: Additional Information -->
                <div class="form-slide" id="slide-8">
                    <h3 class="slide-title">Final Details</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="years_in_business">Years in Business</label>
                            <input type="number" id="years_in_business" name="years_in_business" min="0" placeholder="5">
                        </div>
                        <div class="form-group">
                            <label for="taking_new_work">Taking New Work?</label>
                            <select id="taking_new_work" name="taking_new_work" required>
                                <option value="">Please select</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                            <span class="field-error"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="website_url">Company Website</label>
                        <input type="url" id="website_url" name="website_url" placeholder="https://yourcompany.com">
                    </div>

                    <div class="form-group">
                        <label for="reviews__google_profile_url">Link to Reviews (Google, Yelp, etc.)</label>
                        <input type="url" id="reviews__google_profile_url" name="reviews__google_profile_url" placeholder="https://www.google.com/maps/place/your-business">
                    </div>

                    <div class="form-group">
                        <label for="vendor_preferred_contact_method">Preferred Contact Method</label>
                        <select id="vendor_preferred_contact_method" name="vendor_preferred_contact_method" required>
                            <option value="">Please select</option>
                            <option value="Email">Email</option>
                            <option value="Text">Text</option>
                            <option value="Phone call">Phone call</option>
                            <option value="Any method">Any method</option>
                        </select>
                        <span class="field-error"></span>
                    </div>

                    <div class="form-group">
                        <label for="special_requests__notes">Additional Information</label>
                        <textarea id="special_requests__notes" name="special_requests__notes" rows="4" placeholder="Tell us about your specializations, certifications, or any other relevant information"></textarea>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="sms_consent" name="sms_consent" required>
                        <label for="sms_consent">
                            I Consent to Receive SMS Notifications, Emails and Calls from DocksidePros.com. Message Frequency May Vary. Message & Data Rates May Apply. Text HELP For Assistance. You May Reply STOP to Unsubscribe At Any Time. *
                        </label>
                    </div>
                    <span class="field-error"></span>

                    <div class="checkbox-group">
                        <input type="checkbox" id="marketing_consent" name="marketing_consent">
                        <label for="marketing_consent">
                            I Consent To Receive The Occasional Marketing Messages from DocksidePros.com. You May Reply STOP to Unsubscribe At Any Time.
                        </label>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="nav-button previous" onclick="window.prevSlide(8)">
                            <span>←</span> Previous
                        </button>
                        <button type="button" class="nav-button clear" onclick="clearCurrentSlideAndAfter()">
                            Clear Form
                        </button>
                        <button type="submit" class="submit-button" id="submitButton">
                            Get in Touch
                        </button>
                    </div>
                </div>

                <!-- Thank You Page (Slide 9) -->
                <div class="form-slide" id="slide-9">
                    <div style="text-align: center; padding: 40px 20px;">
                        <h2 style="color: #4573a8; font-size: 32px; margin-bottom: 20px;">Thank You for Your Interest!</h2>
                        <p style="font-size: 18px; color: #666; margin-bottom: 40px;">
                            One of our team members will be in contact ASAP.
                        </p>
                        
                        <div class="navigation-buttons" style="justify-content: center; gap: 30px;">
                            <button type="button" class="nav-button previous" onclick="startNewApplication()">
                                New Application
                            </button>
                            <button type="button" class="nav-button next" onclick="window.open('https://docksidepros.com/partners/', '_blank')">
                                Featured Pros Program
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Level 3 Services Modal -->
            <div class="level3-modal" id="level3Modal">
                <div class="level3-modal-content">
                    <div class="level3-modal-header">
                        <h3 id="level3ModalTitle">Select Specific Services</h3>
                        <button class="level3-modal-close" onclick="window.closeLevel3Modal()">&times;</button>
                    </div>
                    <div class="level3-modal-body">
                        <div class="level3-info-text">
                            Please un-check any services you do NOT offer. All services are pre-selected by default.
                        </div>
                        <div id="level3ServicesContainer">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    <div class="level3-modal-footer">
                        <button class="level3-done-button" onclick="window.saveLevel3Services()">Done</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function($) {
        // WordPress compatibility - prevent conflicts with jQuery
        'use strict';
        
        // Ensure widget only initializes once
        if (window.vendorWidgetInitialized) {
            return;
        }
        window.vendorWidgetInitialized = true;
        
        // Service Categories Data with Level 3 Services
        const SERVICE_CATEGORIES = {
            "Boat and Yacht Repair": {
                "subcategories": [
                    "Fiberglass Repair",
                    "Welding & Metal Fabrication",
                    "Carpentry & Woodwork",
                    "Riggers & Masts",
                    "Jet Ski Repair",
                    "Boat Canvas and Upholstery",
                    "Boat Decking and Yacht Flooring"
                ],
                "level3Services": {
                    "Fiberglass Repair": [
                        "Hull Crack or Structural Repair",
                        "Gelcoat Repair and Color Matching",
                        "Transom Repair & Reinforcement",
                        "Deck Delamination & Soft Spot Repair",
                        "Stringer & Bulkhead Repair",
                        "Other"
                    ],
                    "Welding & Metal Fabrication": [
                        "Aluminum or Stainless Steel Hull Repairs",
                        "Custom Railings",
                        "Ladders or Boarding Equipment",
                        "T-Tops, Hardtops or Bimini Frames",
                        "Fuel or Water Tank Fabrication",
                        "Exhaust, Engine Bed or Structural Reinforcement",
                        "Other"
                    ],
                    "Carpentry & Woodwork": [
                        "Interior Woodwork and Cabinetry",
                        "Teak Deck Repair or Replacement",
                        "Varnishing & Wood Finishing",
                        "Structural Wood Repairs",
                        "Custom Furniture or Fixtures",
                        "Other"
                    ],
                    "Riggers & Masts": [
                        "Standing Rigging Inspection or Replacement",
                        "Running Rigging Replacement",
                        "Mast Stepping & Unstepping",
                        "Mast Repair or Replacement",
                        "Rig Tuning & Load Testing",
                        "Fitting & Hardware Inspection",
                        "Other"
                    ],
                    "Jet Ski Repair": [
                        "Engine Diagnostics & Repair",
                        "Jet Pump Rebuild or Replacement",
                        "Fuel Systems Cleaning or Repair",
                        "Battery or Electrical Repairs",
                        "Cooling System Flush or Repair",
                        "General Maintenance",
                        "Other"
                    ],
                    "Boat Canvas and Upholstery": [
                        "Upholstery",
                        "Canvas or Sunshade",
                        "Trim and Finish",
                        "Boat Cover or T-Top",
                        "Acrylic or Strataglass Enclosures",
                        "Other"
                    ],
                    "Boat Decking and Yacht Flooring": [
                        "SeaDek",
                        "Real Teak Wood",
                        "Cork",
                        "Synthetic Teak",
                        "Vinyl Flooring",
                        "Tile Flooring",
                        "Other"
                    ]
                }
            },
            "Boat Maintenance": {
                "subcategories": [
                    "Ceramic Coating",
                    "Boat Detailing",
                    "Bottom Painting",
                    "Boat and Yacht Maintenance",
                    "Boat Oil Change",
                    "Bilge Cleaning",
                    "Jet Ski Maintenance",
                    "Barnacle Cleaning",
                    "Fire and Safety Equipment and Services",
                    "Boat Wrapping and Marine Protection Film",
                    "Finsulate"
                ],
                "level3Services": {
                    "Ceramic Coating": ["Ceramic Coating"],
                    "Boat Detailing": ["Boat Detailing"],
                    "Bottom Painting": ["Bottom Painting"],
                    "Boat and Yacht Maintenance": [
                        "Ceramic Coating",
                        "Boat Detailing",
                        "Bottom Painting",
                        "Oil Change",
                        "Bilge Cleaning",
                        "Jet Ski Maintenance",
                        "Barnacle Cleaning",
                        "Fire and Safety Equipment and Services",
                        "Boat Wrapping or Marine Protection Film",
                        "Finsulate",
                        "Other"
                    ],
                    "Boat Oil Change": ["Oil Change"],
                    "Bilge Cleaning": ["Bilge Cleaning"],
                    "Jet Ski Maintenance": ["Jet Ski Maintenance"],
                    "Barnacle Cleaning": ["Barnacle Cleaning"],
                    "Fire and Safety Equipment and Services": ["Fire and Safety Equipment and Services"],
                    "Boat Wrapping and Marine Protection Film": ["Boat Wrapping or Marine Protection Film"],
                    "Finsulate": ["Finsulate"]
                }
            },
            "Marine Systems": {
                "subcategories": [
                    "Marine Systems Install and Sales",
                    "Yacht Stabilizers and Seakeepers",
                    "Instrument Panel and Dashboard",
                    "Yacht AC Sales",
                    "Yacht AC Service",
                    "Boat Electrical Service",
                    "Boat Sound Systems",
                    "Yacht Plumbing",
                    "Boat Lighting",
                    "Yacht Refrigeration and Watermakers",
                    "Marine Batteries & Battery Installation",
                    "Yacht Mechanical Systems"
                ],
                "level3Services": {
                    "Marine Systems Install and Sales": [
                        "Stabilizers or Seakeepers",
                        "Instrument Panel and Dashboard",
                        "AC Sales or Service",
                        "Electrical Service",
                        "Sound System",
                        "Plumbing",
                        "Lighting",
                        "Refrigeration or Watermakers",
                        "Marine Batteries & Batteries Installation",
                        "Yacht Mechanical Systems"
                    ],
                    "Yacht Stabilizers and Seakeepers": [
                        "New Seakeeper Install",
                        "Other Stabilizer Install",
                        "Stabilizer Maintenance",
                        "Stabilizer Retrofit or Upgrades"
                    ],
                    "Instrument Panel and Dashboard": [
                        "Electronic Dashboard Install or Upgrades",
                        "Instrument Panel Rewiring & Troubleshooting",
                        "Custom Dashboard Fabrication & Refacing",
                        "Gauge Replacement & Calibration",
                        "Backlighting & Switch Panel Modernization"
                    ],
                    "Yacht AC Sales": ["New AC Install or Replacement"],
                    "Yacht AC Service": [
                        "New AC Install or Replacement",
                        "AC Maintenance & Servicing",
                        "Refrigerant Charging & Leak Repair",
                        "Pump & Water Flow Troubleshooting",
                        "Thermostat & Control Panel Upgrades"
                    ],
                    "Boat Electrical Service": [
                        "Battery System Install or Maintenance",
                        "Wiring & Rewiring",
                        "Shore Power & Inverter Systems",
                        "Lighting Systems",
                        "Electrical Panel & Breaker",
                        "Navigation & Communication",
                        "Generator Electrical Integration",
                        "Solar Power & Battery Charging"
                    ],
                    "Boat Sound Systems": [
                        "Marine Audio System Install",
                        "Speaker & Subwoofer Upgrades",
                        "Amplifier Setup & Tuning",
                        "Multi-Zone Audio Configuration",
                        "Troubleshooting & System Repairs"
                    ],
                    "Yacht Plumbing": [
                        "Freshwater System Install or Repair",
                        "Marine Head & Toilet Systems",
                        "Greywater or Blackwater Tank Maintenance",
                        "Bilge Pump Install or Drainage",
                        "Watermaker (Desalinator) Service & Install"
                    ],
                    "Boat Lighting": [
                        "Navigation & Anchor Light Install",
                        "Underwater Lighting",
                        "Interior Cabin Lighting",
                        "Deck, Cockpit & Courtesy Lighting",
                        "Electrical Troubleshooting & Wiring"
                    ],
                    "Yacht Refrigeration and Watermakers": [
                        "Marine Refrigerator & Freezer Install",
                        "Refrigeration System Repairs & Troubleshooting",
                        "Watermaker (Desalinator) Install",
                        "Watermaker Maintenance & Servicing",
                        "Cold Plate & Evaporator Upgrades"
                    ],
                    "Marine Batteries & Battery Installation": [
                        "Marine Battery Sales",
                        "Marine Battery Installation",
                        "Battery Bank Design & Upgrades",
                        "Charging System Integration",
                        "Battery Testing & Maintenance"
                    ],
                    "Yacht Mechanical Systems": [
                        "Propulsion Systems",
                        "Steering & Rudder Systems",
                        "Hydraulic Systems",
                        "Fuel Systems",
                        "Bilge & Waste Systems"
                    ]
                }
            },
            "Engines and Generators": {
                "subcategories": [
                    "Engines and Generators Sales/Service",
                    "Generator Sales or Service",
                    "Generator Sales",
                    "Generator Service",
                    "Engine Service or Sales",
                    "Engine Service",
                    "Engine Sales",
                    "Diesel Engine Sales",
                    "Outboard Engine Sales",
                    "Inboard Engine Sales",
                    "Marine Exhaust Systems and Service"
                ],
                "level3Services": {
                    "Engines and Generators Sales/Service": [
                        "Outboard Engine Service",
                        "Outboard Engine Sales",
                        "Inboard Engine Service",
                        "Inboard Engine Sales",
                        "Diesel Engine Service",
                        "Diesel Engine Sales",
                        "Generator Service",
                        "Generator Sales",
                        "Exhaust Systems & Service"
                    ],
                    "Generator Sales or Service": [
                        "Generator Installation",
                        "Routine Generator Maintenance",
                        "Electrical System Integration & Transfer Switches",
                        "Diagnostics & Repairs",
                        "Sound Shielding & Vibration Control",
                        "Generator Sales",
                        "Exhaust Systems & Service"
                    ],
                    "Generator Sales": [
                        "Cummins Onan",
                        "Kohler",
                        "Northern Lights",
                        "Caterpillar",
                        "Volvo Penta",
                        "NextGen",
                        "Phasor",
                        "Fischer Panda",
                        "Not Sure/Other"
                    ],
                    "Generator Service": [
                        "Generator Installation",
                        "Routine Generator Maintenance",
                        "Electrical System Integration & Transfer Switches",
                        "Diagnostics & Repairs",
                        "Sound Shielding & Vibration Control",
                        "Exhaust Systems & Service"
                    ],
                    "Engine Service or Sales": [
                        "Diesel Engine Sales",
                        "Inboard Engine Sales",
                        "Outboard Engine Sales",
                        "Diesel Engine Maintenance",
                        "Outboard Engine Maintenance",
                        "Inboard Engine Maintenance",
                        "Diesel Engine Repair, Rebuild or Refit",
                        "Outboard Engine Repair, Rebuild or Refit",
                        "Inboard Engine Repair, Rebuild or Refit",
                        "Exhaust Systems & Service"
                    ],
                    "Engine Service": [
                        "Diesel Engine Maintenance",
                        "Outboard Engine Maintenance",
                        "Inboard Engine Maintenance",
                        "Diesel Engine Repair, Rebuild or Refit",
                        "Outboard Engine Repair, Rebuild or Refit",
                        "Inboard Engine Repair, Rebuild or Refit",
                        "Exhaust Systems & Service",
                        "Sound Shielding & Vibration Control"
                    ],
                    "Engine Sales": [
                        "Diesel Engine Sales",
                        "Inboard Engine Sales",
                        "Outboard Engine Sales",
                        "Electric Engine Sales"
                    ],
                    "Diesel Engine Sales": [
                        "Caterpillar",
                        "MAN Engines",
                        "MTU",
                        "Volvo Penta",
                        "Cummins Marine",
                        "Yanmar Marine",
                        "Perkins Marine",
                        "John Deer Marine"
                    ],
                    "Outboard Engine Sales": [
                        "Mercury",
                        "Yamaha",
                        "Suzuki",
                        "Honda",
                        "Seven Marine"
                    ],
                    "Inboard Engine Sales": [
                        "Caterpillar",
                        "MAN Engines",
                        "MTU",
                        "Volvo Penta",
                        "Cummins Marine",
                        "Yanmar Marine"
                    ],
                    "Marine Exhaust Systems and Service": [
                        "Marine Exhaust Fabrication",
                        "Exhaust System Repair & Overhaul",
                        "Exhaust Insulation & Lagging",
                        "Exhaust Filtration & Emissions Compliance",
                        "Exhaust Leak Detection & Corrosion Prevention"
                    ]
                }
            },
            "Boat Towing": {
                "subcategories": [
                    "Get Emergency Tow",
                    "Get Towing Membership"
                ],
                "level3Services": {}
            },
            "Boater Resources": {
                "subcategories": [
                    "Boater Resources",
                    "Yacht WiFi",
                    "Provisioning",
                    "Boat and Yacht Parts",
                    "Yacht Photography",
                    "Yacht Videography",
                    "Maritime Advertising, PR and Web Design",
                    "Yacht Crew Placement",
                    "Yacht Account Management and Bookkeeping",
                    "Boat Salvage",
                    "Maritime Attorney"
                ],
                "level3Services": {
                    "Boater Resources": [
                        "Boat or Yacht Parts",
                        "Vessel WiFi or Communications",
                        "Provisioning",
                        "Boat Salvage",
                        "Photography or Videography",
                        "Crew Management",
                        "Account Management and Bookkeeping",
                        "Marketing or Web Design",
                        "Vessel Management",
                        "Maritime Attorney",
                        "Other"
                    ],
                    "Yacht WiFi": [
                        "New WiFi",
                        "WiFi Diagnostics or Troubleshooting",
                        "Boat Network",
                        "Satellite",
                        "Cellular",
                        "Marina Connections"
                    ],
                    "Provisioning": [
                        "Food & Beverage Provisioning",
                        "Galley & Kitchen Supplies",
                        "Crew Provisioning",
                        "Cabin & Guest Comfort Supplies",
                        "Medical & First Aid Provisioning",
                        "Cleaning & Maintenance Supplies",
                        "Floral & Décor Provisioning",
                        "Custom Orders & Luxury Concierge Items",
                        "Fishing, Dive or Watersports Supplies"
                    ],
                    "Boat and Yacht Parts": [
                        "Engine & Propulsion Parts",
                        "Electrical & Battery Systems Parts",
                        "Steering & Control Systems Parts",
                        "Navigation & Electronics Parts",
                        "Plumbing & Water Systems Parts",
                        "Hull, Deck & Hardware Parts",
                        "Safety Equipment and Emergency Gear",
                        "AC, Refrigeration or Watermaker Parts",
                        "Canvas, Covers or Upholstery Parts",
                        "Paint, Maintenance or Cleaning Supplies",
                        "Trailer or Towing Components",
                        "Anchoring or Mooring Gear Parts",
                        "Other"
                    ],
                    "Yacht Photography": [
                        "Listing Photography or Videography (Brokerage & Sales)",
                        "Lifestyle & Charter Photography or Videography",
                        "Drone & Aerial Photography or Videography",
                        "Virtual Tours/3D Walkthroughs",
                        "Refit or Restoration Progress Documentation",
                        "Underwater Photography or Videography",
                        "Event Coverage",
                        "Social Media Reels/Short-Form Content"
                    ],
                    "Yacht Videography": [
                        "Listing Photography or Videography (Brokerage & Sales)",
                        "Lifestyle & Charter Photography or Videography",
                        "Drone & Aerial Photography or Videography",
                        "Virtual Tours/3D Walkthroughs",
                        "Refit or Restoration Progress Documentation",
                        "Underwater Photography or Videography",
                        "Event Coverage",
                        "Social Media Reels/Short-Form Content"
                    ],
                    "Maritime Advertising, PR and Web Design": [
                        "Search Engine Optimization (SEO)",
                        "Web Design",
                        "PR, Influencer or Affiliate Marketing",
                        "Podcasts",
                        "Sponsorships",
                        "Paid Ads Management",
                        "Social Media Marketing",
                        "Email Marketing & Automation",
                        "Content Marketing and Blogging",
                        "Video Marketing",
                        "CRM Integration & Lead Nurturing"
                    ],
                    "Yacht Crew Placement": [
                        "Captain",
                        "First Mate",
                        "Engineer",
                        "Deckhand",
                        "Chef or Cook",
                        "Stew",
                        "Bosun",
                        "Purser for Provisioning, Accounting or Logistics",
                        "Nanny, Masseuse or Personal Trainer",
                        "Security Officer or Bodyguard"
                    ],
                    "Yacht Account Management and Bookkeeping": [
                        "Operational Expense Tracking",
                        "Crew Payroll & Expense Reconciliation",
                        "Budget Planning & Forecasting",
                        "Charter Income & Expense Reporting",
                        "Vendor & Invoice Management",
                        "Tax Compliance & VAT Management",
                        "Insurance Premium & Policy Accounting",
                        "Financial Reporting & Owner Statements"
                    ],
                    "Boat Salvage": [
                        "Emergency Water Removal",
                        "Emergency Boat Recovery",
                        "Sell Boat for Parts",
                        "Mold/Water Remediation"
                    ],
                    "Maritime Attorney": [
                        "Maritime Personal Injury Case",
                        "Marine Insurance Dispute",
                        "Maritime Commercial and Contract Case",
                        "Environmental & Regulatory Compliance",
                        "Vessel Documentation and Transactions",
                        "Maritime Criminal Defense",
                        "Other"
                    ]
                }
            },
            "Buying or Selling a Boat": {
                "subcategories": [
                    "Buying or Selling a Boat or Yacht",
                    "Boat Insurance",
                    "Yacht Insurance",
                    "Yacht Builder",
                    "Yacht Broker",
                    "Boat Broker",
                    "Boat Builder",
                    "Boat Financing",
                    "Boat Surveyors",
                    "Yacht Dealers",
                    "Boat Dealers"
                ],
                "level3Services": {
                    "Buying or Selling a Boat or Yacht": ["Buy", "Sell", "Trade"],
                    "Boat Insurance": [
                        "I Just Bought the Vessel",
                        "New Vessel Policy",
                        "Looking For Quotes Before Purchasing Vessel"
                    ],
                    "Yacht Insurance": [
                        "I Just Bought the Vessel",
                        "New Vessel Policy",
                        "Looking For Quotes Before Purchasing Vessel"
                    ],
                    "Yacht Builder": [],
                    "Yacht Broker": [
                        "Buy a New Yacht",
                        "Buy a Pre-Owned Yacht",
                        "Sell a Pre-Owned Yacht",
                        "Trade My Yacht",
                        "Looking to Charter My Yacht",
                        "Looking for Yacht Management"
                    ],
                    "Boat Broker": [
                        "Buy a New Yacht",
                        "Buy a Pre-Owned Yacht",
                        "Sell a Pre-Owned Yacht",
                        "Trade My Yacht",
                        "Looking to Charter My Yacht",
                        "Looking for Yacht Management"
                    ],
                    "Boat Builder": [],
                    "Boat Financing": [
                        "New Boat Financing",
                        "Used Boat Financing",
                        "Refinancing"
                    ],
                    "Boat Surveyors": [
                        "Hull & Engine(s)",
                        "Thermal Imaging",
                        "Insurance/Damage",
                        "Hull Only",
                        "Engine(s) Only"
                    ],
                    "Yacht Dealers": [
                        "Buy a New Yacht",
                        "Buy a Pre-Owned Yacht",
                        "Sell a Pre-Owned Yacht",
                        "Trade My Yacht",
                        "Looking to Charter My Yacht",
                        "Looking for Yacht Management"
                    ],
                    "Boat Dealers": [
                        "Buy a New Boat",
                        "Buy a Pre-Owned Boat",
                        "Sell a Pre-Owned Boat",
                        "Trade My Boat",
                        "Looking to Charter My Boat",
                        "Looking for Boat Management"
                    ]
                }
            },
            "Docks, Seawalls and Lifts": {
                "subcategories": [
                    "Dock, Boat Lift or Seawall Builders or Repair",
                    "Boat Lift Installers",
                    "Floating Dock Sales",
                    "Seawall Construction",
                    "Dock, Seawall or Piling Cleaning"
                ],
                "level3Services": {
                    "Dock, Boat Lift or Seawall Builders or Repair": [
                        "Seawall Construction or Repair",
                        "New Dock",
                        "Dock Repair",
                        "Pilings or Structural Support",
                        "Floating Docks",
                        "Boat Lift",
                        "Seawall or Piling Cleaning"
                    ],
                    "Boat Lift Installers": [
                        "New Boat Lift",
                        "Boat Lift Installation",
                        "Lift Motor & Gearbox Repair",
                        "Cable & Pulley Replacement",
                        "Annual Maintenance & Alignment"
                    ],
                    "Floating Dock Sales": [
                        "New Floating Dock",
                        "Floating Dock Installation",
                        "Floating Dock Repair & Float Replacement",
                        "Custom Modifications & Add-Ons",
                        "Seasonal Maintenance & Dock Repositioning"
                    ],
                    "Seawall Construction": [
                        "New Seawall Construction",
                        "Seawall Repair & Reinforcement",
                        "Cap Replacement & Restoration",
                        "Erosion Control & Backfill Replacement",
                        "Seawall Maintenance or Inspection"
                    ],
                    "Dock, Seawall or Piling Cleaning": [
                        "Dock Cleaning",
                        "Seawall Cleaning",
                        "Piling Cleaning",
                        "Commercial or Industrial Requests"
                    ]
                }
            },
            "Dock and Slip Rental": {
                "subcategories": [
                    "Dock and Slip Rental",
                    "Rent My Dock"
                ],
                "level3Services": {
                    "Dock and Slip Rental": [
                        "Private Dock",
                        "Boat Slip",
                        "Marina",
                        "Mooring Ball"
                    ],
                    "Rent My Dock": [
                        "Private Dock",
                        "Boat Slip",
                        "Marina",
                        "Mooring Ball"
                    ]
                }
            },
            "Fuel Delivery": {
                "subcategories": [
                    "Fuel Delivery"
                ],
                "level3Services": {
                    "Fuel Delivery": [
                        "Dyed Diesel Fuel (For Boats)",
                        "Regular Diesel Fuel (Landside Business)",
                        "Rec 90 (Ethanol Free Gas)"
                    ]
                }
            },
            "Boat Charters and Rentals": {
                "subcategories": [
                    "Boat Charters and Rentals",
                    "Boat Clubs",
                    "Fishing Charters",
                    "Yacht and Catamaran Charters",
                    "Sailboat Charters",
                    "eFoil, Kiteboarding & Wing Surfing",
                    "Dive Equipment and Services",
                    "Jet Ski Rental",
                    "Kayak Rental",
                    "Paddleboard Rental",
                    "Pontoon Boat Charter or Rental",
                    "Party Boat Charter",
                    "Private Yacht Charter"
                ],
                "level3Services": {
                    "Boat Charters and Rentals": [
                        "Weekly or Monthly Yacht or Catamaran Charter",
                        "Daily Yacht or Catamaran Charter",
                        "Sailboat Charter",
                        "Fishing Charter",
                        "Party Boat Charter",
                        "Pontoon Boat Charter or Rental",
                        "Jet Ski Rental",
                        "Paddleboard Rental",
                        "Kayak Rental",
                        "eFoil, Kiteboarding or Wing Surfing Lessons",
                        "Boat Club",
                        "Boat Rental"
                    ],
                    "Boat Clubs": [
                        "Membership Boat Club",
                        "Yacht Club",
                        "Private Fractional Ownership Club",
                        "Sailing Club",
                        "Luxury Boat Membership Club"
                    ],
                    "Fishing Charters": [
                        "Inshore Fishing Charter",
                        "Offshore (Deep Sea) Fishing Charter",
                        "Reef & Wreck Fishing Charter",
                        "Drift Boat Charter",
                        "Freshwater Fishing Charter",
                        "Private Party Boat Charter",
                        "Fishing Resort Vacation"
                    ],
                    "Yacht and Catamaran Charters": [
                        "Day Yacht Charter",
                        "Day Catamaran Charter",
                        "Group Yacht or Catamaran Charter",
                        "Weekly or Monthly Catamaran or Yacht Charter",
                        "Other"
                    ],
                    "Sailboat Charters": [
                        "Bareboat Charter (No Captain or Crew)",
                        "Skippered Charter",
                        "Crewed Charter",
                        "Cabin Charter",
                        "Sailing Charter (Learn to Sail)",
                        "Weekly or Monthly Charter"
                    ],
                    "eFoil, Kiteboarding & Wing Surfing": [
                        "eFoil Lessons",
                        "eFoil Equipment",
                        "Kiteboarding Lessons",
                        "Kiteboarding Equipment",
                        "Wing Surfing Lessons",
                        "Wing Surfing Equipment"
                    ],
                    "Dive Equipment and Services": [
                        "Private Scuba Diving Charter",
                        "Shared Scuba Diving Charter",
                        "Scuba Equipment Rental",
                        "Snorkel and Free Diving Charter",
                        "Night Diving",
                        "Underwater Scooter Rental"
                    ],
                    "Jet Ski Rental": [
                        "Hourly Jet Ski Rental",
                        "Multiple Day Jet Ski Rental",
                        "Jet Ski Tour"
                    ],
                    "Kayak Rental": [
                        "Hourly Kayak Rental",
                        "Multiple Day Kayak Rental",
                        "Kayak Tour"
                    ],
                    "Paddleboard Rental": [
                        "Hourly Paddleboard Rental",
                        "Multiple Day Paddleboard Rental",
                        "Paddleboard Tour"
                    ],
                    "Pontoon Boat Charter or Rental": [
                        "Hourly Pontoon Rental",
                        "Multiple Day Pontoon Rental",
                        "Pontoon Charter"
                    ],
                    "Party Boat Charter": [
                        "Pontoon Party Boat",
                        "Catamaran Party Boat",
                        "Yacht Party Boat",
                        "50+ Person Party Boat"
                    ],
                    "Private Yacht Charter": [
                        "Private Motoryacht Charter",
                        "Private Sailing Catamaran Charter",
                        "Private Fishing Yacht Charter",
                        "Superyacht Private Charter"
                    ]
                }
            },
            "Boat Hauling and Yacht Delivery": {
                "subcategories": [
                    "Yacht Delivery",
                    "Boat Hauling and Transport"
                ],
                "level3Services": {}
            },
            "Maritime Education and Training": {
                "subcategories": [
                    "Maritime Education and Training"
                ],
                "level3Services": {
                    "Maritime Education and Training": [
                        "Yacht, Sailboat or Catamaran On Water Training",
                        "Interested In Buying a Boat or Insurance Sign Off",
                        "Maritime Academy",
                        "Sailing Schools",
                        "Captains License"
                    ]
                }
            },
            "Yacht Management": {
                "subcategories": [
                    "Yacht Management"
                ],
                "level3Services": {
                    "Yacht Management": [
                        "Full Service Vessel Management",
                        "Technical Management (Maintenance, Repairs, Upgrades, etc)",
                        "Crew Management",
                        "Accounting & Financial Management",
                        "Insurance & Risk Management",
                        "Regulatory Compliance",
                        "Maintenance & Refit Management",
                        "Logistical Support (Transportation, Provisioning, Fuel or Dockage)",
                        "Wash Downs and Systems Checks"
                    ]
                }
            },
            "Waterfront Property": {
                "subcategories": [
                    "Waterfront Homes For Sale",
                    "Sell Your Waterfront Home",
                    "Waterfront New Developments"
                ],
                "level3Services": {
                    "Waterfront Homes For Sale": [
                        "Buy a Waterfront Home or Condo",
                        "Sell a Waterfront Home or Condo",
                        "Buy a Waterfront New Development",
                        "Rent a Waterfront Property"
                    ],
                    "Sell Your Waterfront Home": [
                        "Buy a Waterfront Home or Condo",
                        "Sell a Waterfront Home or Condo",
                        "Buy a Waterfront New Development",
                        "Rent a Waterfront Property"
                    ],
                    "Waterfront New Developments": [
                        "Buy a Waterfront Home or Condo",
                        "Sell a Waterfront Home or Condo",
                        "Buy a Waterfront New Development",
                        "Rent a Waterfront Property"
                    ]
                }
            },
            "Wholesale or Dealer Product Pricing": {
                "subcategories": [
                    "Wholesale or Dealer Product Pricing"
                ],
                "level3Services": {
                    "Wholesale or Dealer Product Pricing": [
                        "Apparel",
                        "Boat Accessories",
                        "Boat Maintenance & Cleaning Products",
                        "Boat Safety Products",
                        "Diving Equipment",
                        "Dock Accessories",
                        "Fishing Gear",
                        "Personal Watercraft",
                        "Other"
                    ]
                }
            }
        };

        // Widget State
        const widgetState = {
            primaryCategory: '',
            primaryServices: new Set(),
            primaryLevel3Services: {},
            additionalCategories: new Set(),
            additionalServices: new Set(),
            additionalLevel3Services: {},
            currentLevel3Context: null,
            currentSlide: 1,
            totalSlides: 9,
            formData: {},
            coverageType: '',
            selectedStates: new Set(),
            selectedCounties: new Set(),
            selectedZipCodes: '',
            debugMode: window.location.hostname === 'localhost' || window.location.search.includes('debug=true')
        };

        // State abbreviations array
        const states = [
            {code: 'AL', name: 'Alabama'}, {code: 'AK', name: 'Alaska'}, {code: 'AZ', name: 'Arizona'},
            {code: 'AR', name: 'Arkansas'}, {code: 'CA', name: 'California'}, {code: 'CO', name: 'Colorado'},
            {code: 'CT', name: 'Connecticut'}, {code: 'DE', name: 'Delaware'}, {code: 'FL', name: 'Florida'},
            {code: 'GA', name: 'Georgia'}, {code: 'HI', name: 'Hawaii'}, {code: 'ID', name: 'Idaho'},
            {code: 'IL', name: 'Illinois'}, {code: 'IN', name: 'Indiana'}, {code: 'IA', name: 'Iowa'},
            {code: 'KS', name: 'Kansas'}, {code: 'KY', name: 'Kentucky'}, {code: 'LA', name: 'Louisiana'},
            {code: 'ME', name: 'Maine'}, {code: 'MD', name: 'Maryland'}, {code: 'MA', name: 'Massachusetts'},
            {code: 'MI', name: 'Michigan'}, {code: 'MN', name: 'Minnesota'}, {code: 'MS', name: 'Mississippi'},
            {code: 'MO', name: 'Missouri'}, {code: 'MT', name: 'Montana'}, {code: 'NE', name: 'Nebraska'},
            {code: 'NV', name: 'Nevada'}, {code: 'NH', name: 'New Hampshire'}, {code: 'NJ', name: 'New Jersey'},
            {code: 'NM', name: 'New Mexico'}, {code: 'NY', name: 'New York'}, {code: 'NC', name: 'North Carolina'},
            {code: 'ND', name: 'North Dakota'}, {code: 'OH', name: 'Ohio'}, {code: 'OK', name: 'Oklahoma'},
            {code: 'OR', name: 'Oregon'}, {code: 'PA', name: 'Pennsylvania'}, {code: 'RI', name: 'Rhode Island'},
            {code: 'SC', name: 'South Carolina'}, {code: 'SD', name: 'South Dakota'}, {code: 'TN', name: 'Tennessee'},
            {code: 'TX', name: 'Texas'}, {code: 'UT', name: 'Utah'}, {code: 'VT', name: 'Vermont'},
            {code: 'VA', name: 'Virginia'}, {code: 'WA', name: 'Washington'}, {code: 'WV', name: 'West Virginia'},
            {code: 'WI', name: 'Wisconsin'}, {code: 'WY', name: 'Wyoming'}
        ];

        // Debug logger
        function debugLog(message, data = null) {
            if (widgetState.debugMode) {
                console.log(`[Vendor Widget] ${message}`, data || '');
            }
        }

        // Close widget function
        window.closeWidget = function() {
            if (confirm('Are you sure you want to close? Your progress will be saved.')) {
                // Try to close the parent popup window if we're in one
                if (window.self !== window.top) {
                    // We're in an iframe - try to close the parent popup
                    try {
                        // Method 1: Send message to parent to close popup
                        if (window.parent && window.parent.postMessage) {
                            window.parent.postMessage({
                                type: 'closePopup',
                                source: 'vendorWidget'
                            }, '*');
                        }
                        
                        // Method 2: Try to close parent window directly (may not work due to security)
                        if (window.parent && window.parent.close) {
                            window.parent.close();
                        }
                        
                        // Method 3: If parent has a specific close function (depends on popup implementation)
                        if (window.parent && window.parent.closeModal) {
                            window.parent.closeModal();
                        }
                        
                    } catch (e) {
                        // Cross-origin restrictions may prevent this
                        console.log('Cannot close parent popup due to security restrictions');
                    }
                } else {
                    // We're not in an iframe, just hide the widget
                    document.getElementById('vendor-survey-widget').style.display = 'none';
                }
            }
        }

        // Slide Navigation Functions
        window.nextSlide = function(currentSlideNum) {
            debugLog(`Moving from slide ${currentSlideNum} to next`);
            
            // Validate current slide before moving
            if (!validateCurrentSlide(currentSlideNum)) {
                return;
            }
            
            // Special handling for slides that might be skipped
            let nextSlideNum = currentSlideNum + 1;
            
            // Skip slide 6 if no additional categories selected
            if (currentSlideNum === 5 && widgetState.additionalCategories.size === 0) {
                nextSlideNum = 7;
            }
            
            // Hide current slide
            const currentSlide = document.getElementById(`slide-${currentSlideNum}`);
            currentSlide.classList.remove('active');
            
            // Show next slide
            const nextSlide = document.getElementById(`slide-${nextSlideNum}`);
            if (nextSlide) {
                nextSlide.classList.add('active');
                widgetState.currentSlide = nextSlideNum;
                updateProgress();
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
        }

        window.prevSlide = function(currentSlideNum) {
            try {
                debugLog(`Moving from slide ${currentSlideNum} to previous`);
                
                // Clear any temporary UI state that might cause issues
                clearTemporaryUIState();
                
                // Clear subsequent form data when going back
                clearSubsequentFormData(currentSlideNum);
                
                // Special handling for slides that might be skipped
                let prevSlideNum = currentSlideNum - 1;
                
                // Skip slide 6 when going back if no additional categories
                if (currentSlideNum === 7 && widgetState.additionalCategories.size === 0) {
                    prevSlideNum = 5;
                }
                
                // Hide current slide
                const currentSlide = document.getElementById(`slide-${currentSlideNum}`);
                if (!currentSlide) {
                    console.error(`Current slide not found: slide-${currentSlideNum}`);
                    return;
                }
                currentSlide.classList.remove('active');
                
                // Show previous slide
                const prevSlide = document.getElementById(`slide-${prevSlideNum}`);
                if (prevSlide) {
                    prevSlide.classList.add('active');
                    widgetState.currentSlide = prevSlideNum;
                    
                    // Refresh slide-specific UI state
                    refreshSlideUIState(prevSlideNum);
                    
                    updateProgress();
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                } else {
                    console.error(`Previous slide not found: slide-${prevSlideNum}`);
                }
            } catch (error) {
                console.error('Error in prevSlide:', error);
                debugLog('Navigation error:', error);
            }
        }

        // Validate current slide
        function validateCurrentSlide(slideNum) {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll(`#slide-${slideNum} .field-error`).forEach(error => {
                error.textContent = '';
            });
            
            switch(slideNum) {
                case 1: // Company name
                    const companyName = document.getElementById('vendor_company_name').value.trim();
                    if (!companyName) {
                        showFieldError('vendor_company_name', 'Company name is required');
                        isValid = false;
                    }
                    break;
                    
                case 2: // Address
                    const address1 = document.getElementById('address1').value.trim();
                    const city = document.getElementById('city').value.trim();
                    const state = document.getElementById('state').value.trim();
                    const postalCode = document.getElementById('postalCode').value.trim();
                    
                    // Address validation
                    if (!address1) {
                        showFieldError('address1', 'Street address is required');
                        isValid = false;
                    } else if (address1.length < 5) {
                        showFieldError('address1', 'Please enter a complete street address');
                        isValid = false;
                    } else if (address1.length > 100) {
                        showFieldError('address1', 'Address is too long (max 100 characters)');
                        isValid = false;
                    }
                    
                    // City validation
                    if (!city) {
                        showFieldError('city', 'City is required');
                        isValid = false;
                    } else if (city.length < 2 || !/^[a-zA-Z\s\-\.]+$/.test(city)) {
                        showFieldError('city', 'Please enter a valid city name');
                        isValid = false;
                    }
                    
                    // State validation
                    if (!state) {
                        showFieldError('state', 'State is required');
                        isValid = false;
                    }
                    
                    // Zip code validation (##### or #####-#### format)
                    if (!postalCode) {
                        showFieldError('postalCode', 'Zip code is required');
                        isValid = false;
                    } else if (!/^\d{5}(-\d{4})?$/.test(postalCode)) {
                        showFieldError('postalCode', 'Please enter a valid zip code (##### or #####-####)');
                        isValid = false;
                    }
                    break;
                    
                case 3: // Personal info
                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    
                    // First name validation
                    if (!firstName) {
                        showFieldError('firstName', 'First name is required');
                        isValid = false;
                    } else if (firstName.length < 2 || !/^[a-zA-Z\s\-\.]+$/.test(firstName)) {
                        showFieldError('firstName', 'Please enter a valid first name');
                        isValid = false;
                    }
                    
                    // Last name validation
                    if (!lastName) {
                        showFieldError('lastName', 'Last name is required');
                        isValid = false;
                    } else if (lastName.length < 2 || !/^[a-zA-Z\s\-\.]+$/.test(lastName)) {
                        showFieldError('lastName', 'Please enter a valid last name');
                        isValid = false;
                    }
                    
                    // Email validation
                    if (!email) {
                        showFieldError('email', 'Email is required');
                        isValid = false;
                    } else if (!isValidEmail(email)) {
                        showFieldError('email', 'Please enter a valid email address');
                        isValid = false;
                    }
                    
                    // Phone validation (10 digits, various formats accepted)
                    if (!phone) {
                        showFieldError('phone', 'Phone number is required');
                        isValid = false;
                    } else {
                        // Remove all non-digit characters for validation
                        const phoneDigits = phone.replace(/\D/g, '');
                        if (phoneDigits.length !== 10) {
                            showFieldError('phone', 'Please enter a 10-digit phone number with area code');
                            isValid = false;
                        }
                    }
                    break;
                    
                case 4: // Primary category
                    if (!widgetState.primaryCategory) {
                        showFieldError('primary_service_category', 'Please select a primary service category');
                        isValid = false;
                    }
                    if (widgetState.primaryServices.size === 0) {
                        showMessage('error', 'Please select at least one service from your primary category');
                        isValid = false;
                    }
                    break;
                    
                case 7: // Coverage area
                    const coverageType = document.getElementById('coverage_type').value;
                    if (!coverageType) {
                        showFieldError('coverage_type', 'Please select a coverage type');
                        isValid = false;
                    } else {
                        isValid = validateCoverageArea(coverageType);
                    }
                    break;
            }
            
            return isValid;
        }

        // Validate coverage area based on type
        function validateCoverageArea(coverageType) {
            let isValid = true;
            
            switch(coverageType) {
                case 'state':
                    const selectedStates = document.querySelectorAll('#state-checkboxes input[type="checkbox"]:checked');
                    if (selectedStates.length === 0) {
                        showMessage('error', 'Please select at least one state');
                        isValid = false;
                    }
                    break;
                    
                case 'county':
                    const stateSelected = document.getElementById('county_state_selector').value;
                    if (!stateSelected) {
                        showMessage('error', 'Please select a state first');
                        isValid = false;
                    } else {
                        const selectedCounties = document.querySelectorAll('#county-checkboxes input[type="checkbox"]:checked');
                        const fallbackTextarea = document.getElementById('coverage_counties_fallback');
                        const hasFallbackValue = fallbackTextarea && fallbackTextarea.value.trim().length > 0;
                        
                        if (selectedCounties.length === 0 && !hasFallbackValue) {
                            showMessage('error', 'Please select at least one county');
                            isValid = false;
                        }
                    }
                    break;
                    
                case 'zip':
                    const zipCodes = document.getElementById('service_zip_codes').value.trim();
                    if (!zipCodes) {
                        showMessage('error', 'Please enter at least one ZIP code');
                        isValid = false;
                    } else {
                        // Validate each ZIP code in the comma-separated list
                        const zipArray = zipCodes.split(',').map(z => z.trim()).filter(z => z);
                        const invalidZips = zipArray.filter(zip => !/^\d{5}(-\d{4})?$/.test(zip));
                        if (invalidZips.length > 0) {
                            showMessage('error', `Invalid ZIP code format: ${invalidZips.slice(0, 3).join(', ')}${invalidZips.length > 3 ? '...' : ''}`);
                            isValid = false;
                        }
                    }
                    break;
            }
            
            return isValid;
        }

        // Show field error
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorSpan = field.parentNode.querySelector('.field-error');
            if (errorSpan) {
                errorSpan.textContent = message;
                field.focus();
            }
        }

        // Email validation
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // HTML sanitization to prevent XSS
        function sanitizeHtml(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // Validate text input for potential security issues
        function validateTextInput(input, maxLength = 255) {
            if (!input || typeof input !== 'string') return '';
            
            // Remove potential HTML/script tags and limit length
            const sanitized = sanitizeHtml(input.trim());
            return sanitized.substring(0, maxLength);
        }

        // Update progress bar
        function updateProgress() {
            const percentage = Math.round((widgetState.currentSlide / widgetState.totalSlides) * 100);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            
            debugLog(`Progress updated: ${percentage}%`);
        }

        // Show message
        function showMessage(type, text) {
            const messageEl = type === 'success' ? 
                document.getElementById('successMessage') : 
                document.getElementById('errorMessage');
            
            messageEl.innerHTML = text;
            messageEl.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        // Initialize Widget
        function initializeWidget() {
            debugLog('Initializing vendor survey widget');
            
            // Always reset form to initial state when widget loads
            resetFormToInitialState();
            
            setupEventListeners();
            populateStateSelectors();
            updateProgress();
            // Disabled auto-load of draft - form should be empty on each load
            // loadDraft();
            
            // Handle iframe sizing for mobile devices
            if (window.self !== window.top) {
                // We're in an iframe
                setupIframeHeightCommunication();
            }
            
            debugLog('Widget initialized successfully');
        }
        
        // Reset form to completely fresh state
        function resetFormToInitialState() {
            debugLog('Resetting form to initial state');
            
            // Reset widget state
            widgetState.primaryCategory = '';
            widgetState.primaryServices.clear();
            widgetState.primaryLevel3Services = {};
            widgetState.additionalCategories.clear();
            widgetState.additionalServices.clear();
            widgetState.additionalLevel3Services = {};
            widgetState.currentLevel3Context = null;
            widgetState.currentSlide = 1;
            widgetState.formData = {};
            widgetState.coverageType = '';
            widgetState.selectedStates.clear();
            widgetState.selectedCounties.clear();
            widgetState.selectedZipCodes = '';
            
            // Reset all form fields
            const form = document.getElementById('vendorSurveyForm');
            if (form) {
                form.reset();
            }
            
            // Hide all slides except first one
            const slides = document.querySelectorAll('.form-slide');
            slides.forEach((slide, index) => {
                if (index === 0) {
                    slide.classList.add('active');
                } else {
                    slide.classList.remove('active');
                }
            });
            
            // Reset primary services section
            const primaryServicesSection = document.getElementById('primary-services-section');
            if (primaryServicesSection) {
                primaryServicesSection.style.display = 'none';
            }
            
            const primaryServicesContainer = document.getElementById('primary-services-container');
            if (primaryServicesContainer) {
                primaryServicesContainer.innerHTML = '';
            }
            
            // Reset coverage details
            const coverageDetails = document.getElementById('coverage-details');
            if (coverageDetails) {
                coverageDetails.style.display = 'none';
            }
            
            // Clear any error messages
            clearFieldErrors();
            clearTemporaryUIState();
            
            // Clear any existing messages
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            debugLog('Form reset complete');
        }
        
        // Setup communication with parent frame for proper sizing
        function setupIframeHeightCommunication() {
            function sendHeightToParent() {
                try {
                    const height = document.body.scrollHeight;
                    if (window.parent && window.parent.postMessage) {
                        window.parent.postMessage({
                            type: 'vendorWidgetResize',
                            height: Math.max(height, 600) // Minimum height
                        }, '*');
                    }
                } catch (e) {
                    // Cross-origin restrictions prevent this, which is fine
                    debugLog('Cannot communicate with parent frame - cross-origin restriction');
                }
            }
            
            // Send initial height
            setTimeout(sendHeightToParent, 100);
            
            // Send height on window resize
            window.addEventListener('resize', sendHeightToParent);
            
            // Create a ResizeObserver to watch for content changes
            if (window.ResizeObserver) {
                const resizeObserver = new ResizeObserver(sendHeightToParent);
                resizeObserver.observe(document.body);
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Primary category selection
            document.getElementById('primary_service_category').addEventListener('change', handlePrimaryCategorySelection);
            
            // Coverage type selection
            document.getElementById('coverage_type').addEventListener('change', handleCoverageTypeChange);
            
            // County state selector
            document.getElementById('county_state_selector').addEventListener('change', handleCountyStateSelection);
            
            // Form submission
            document.getElementById('vendorSurveyForm').addEventListener('submit', handleSubmit);
            
            // Auto-save draft - DISABLED to ensure form is empty on each load
            // document.addEventListener('input', saveDraft);
            // document.addEventListener('change', saveDraft);
            
            // Add input formatting and validation
            setupInputFormatting();
            
            // Service selection delegation with debouncing
            let selectionTimeout;
            document.addEventListener('click', function(e) {
                // Prevent double-clicks and rapid selections
                clearTimeout(selectionTimeout);
                
                if (e.target.classList.contains('service-tag')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    selectionTimeout = setTimeout(() => {
                        e.target.classList.toggle('selected');
                        handleServiceSelection(e.target);
                    }, 100);
                }
                
                if (e.target.classList.contains('category-option')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    selectionTimeout = setTimeout(() => {
                        handleAdditionalCategorySelection(e.target);
                    }, 100);
                }
            });
        }

        // Populate state selectors
        function populateStateSelectors() {
            // State checkboxes for state coverage
            const stateCheckboxesHtml = states.map(state => `
                <div class="checkbox-item">
                    <input type="checkbox" id="state-${state.code}" value="${state.code}" onchange="updateStateCount()">
                    <label for="state-${state.code}">${state.name}</label>
                </div>
            `).join('');
            document.getElementById('state-checkboxes').innerHTML = stateCheckboxesHtml;
            
            // County state selector
            const countyStateSelectorHtml = '<option value="">Select State</option>' + 
                states.map(state => `<option value="${state.code}">${state.name}</option>`).join('');
            document.getElementById('county_state_selector').innerHTML = countyStateSelectorHtml;
        }

        // Handle primary category selection
        function handlePrimaryCategorySelection(e) {
            const category = e.target.value;
            
            if (!category) {
                // If no category selected, hide the services section and clear state
                document.getElementById('primary-services-section').style.display = 'none';
                widgetState.primaryCategory = '';
                widgetState.primaryServices.clear();
                return;
            }
            
            widgetState.primaryCategory = category;
            widgetState.primaryServices.clear(); // Clear previous selections when changing category
            renderPrimaryServices(category);
            document.getElementById('primary-services-section').style.display = 'block';
        }

        // List of redundant catch-all subcategories to exclude
        const REDUNDANT_SUBCATEGORIES = [
            'Boat Charters and Rentals',
            'Boat and Yacht Maintenance',
            'Boater Resources',
            'Buying or Selling a Boat or Yacht',
            'Dock and Slip Rental',
            'Engines and Generators Sales/Service',
            'Generator Sales or Service',
            'Engine Service or Sales',
            'Fuel Delivery',
            'Marine Systems Install and Sales',
            'Maritime Education and Training',
            'Yacht Management',
            'Wholesale or Dealer Product Pricing'
        ];

        // Categories with single subcategory that have Level 3 services
        const SINGLE_SUBCATEGORY_WITH_LEVEL3 = {
            'Fuel Delivery': 'Fuel Delivery',
            'Maritime Education and Training': 'Maritime Education and Training',
            'Yacht Management': 'Yacht Management',
            'Wholesale or Dealer Product Pricing': 'Wholesale or Dealer Product Pricing'
        };

        // Filter out redundant subcategories
        function filterRedundantSubcategories(services, category) {
            // For categories with only one subcategory that matches the category name, keep it
            if (services.length === 1) {
                return services;
            }
            
            // Filter out redundant catch-all subcategories
            return services.filter(service => !REDUNDANT_SUBCATEGORIES.includes(service));
        }

        // Render primary services
        function renderPrimaryServices(category) {
            const categoryData = SERVICE_CATEGORIES[category];
            let services = categoryData ? categoryData.subcategories : [];
            
            // Check if this is a single-subcategory category with Level 3 services
            if (SINGLE_SUBCATEGORY_WITH_LEVEL3[category]) {
                const singleSubcat = SINGLE_SUBCATEGORY_WITH_LEVEL3[category];
                const hasLevel3 = categoryData.level3Services && categoryData.level3Services[singleSubcat];
                
                if (hasLevel3) {
                    // Auto-select the single subcategory and show Level 3 modal
                    widgetState.primaryServices.add(singleSubcat);
                    
                    // Show a message and button to select Level 3 services
                    const container = document.getElementById('primary-services-container');
                    const level3Count = categoryData.level3Services[singleSubcat].length;
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="margin-bottom: 15px;">This category requires selecting specific services:</p>
                            <button type="button" class="service-tag selected" style="padding: 12px 24px; font-size: 16px; cursor: pointer;"
                                onclick="openLevel3Modal('${singleSubcat}', '${category}', 'primary')">
                                Select Specific Services
                                <span class="service-count-badge">${level3Count}</span>
                            </button>
                        </div>`;
                    
                    // Automatically open the Level 3 modal
                    setTimeout(() => {
                        openLevel3Modal(singleSubcat, category, 'primary');
                    }, 300);
                    return;
                }
            }
            
            // Filter out redundant subcategories for normal categories
            services = filterRedundantSubcategories(services, category);
            
            const container = document.getElementById('primary-services-container');
            
            container.innerHTML = services.map(service => {
                const level3Services = categoryData.level3Services && categoryData.level3Services[service];
                const level3Count = level3Services ? level3Services.length : 0;
                const hasLevel3 = level3Count > 0;
                // Only show badge if there are MORE than 1 Level 3 service (badge = 1 means it's the service itself)
                const showBadge = level3Count > 1;
                const badgeHtml = showBadge ? `<span class="service-count-badge">${level3Count}</span>` : '';
                return `<span class="service-tag" data-category="${category}" data-service="${service}" data-type="primary" data-has-level3="${hasLevel3}" data-level3-count="${level3Count}">${service}${badgeHtml}</span>`;
            }).join('');
        }

        // Handle service selection
        function handleServiceSelection(element) {
            const service = element.dataset.service;
            const category = element.dataset.category;
            const type = element.dataset.type;
            const hasLevel3 = element.dataset.hasLevel3 === 'true';
            
            if (type === 'primary') {
                if (element.classList.contains('selected')) {
                    widgetState.primaryServices.add(service);
                    // Only open modal if there are MORE than 1 Level 3 service
                    const level3Count = parseInt(element.dataset.level3Count || '0');
                    if (hasLevel3 && level3Count > 1) {
                        openLevel3Modal(service, category, 'primary');
                    } else if (level3Count === 1) {
                        // Auto-select the single Level 3 service
                        const categoryData = SERVICE_CATEGORIES[category];
                        if (categoryData && categoryData.level3Services && categoryData.level3Services[service]) {
                            widgetState.primaryLevel3Services[service] = categoryData.level3Services[service];
                        }
                    }
                } else {
                    widgetState.primaryServices.delete(service);
                    // Remove Level 3 selections when deselecting
                    if (widgetState.primaryLevel3Services) {
                        delete widgetState.primaryLevel3Services[service];
                    }
                }
            } else if (type === 'additional') {
                if (element.classList.contains('selected')) {
                    widgetState.additionalServices.add(service);
                    // Only open modal if there are MORE than 1 Level 3 service
                    const level3Count = parseInt(element.dataset.level3Count || '0');
                    if (hasLevel3 && level3Count > 1) {
                        openLevel3Modal(service, category, 'additional');
                    } else if (level3Count === 1) {
                        // Auto-select the single Level 3 service
                        const categoryData = SERVICE_CATEGORIES[category];
                        if (categoryData && categoryData.level3Services && categoryData.level3Services[service]) {
                            widgetState.additionalLevel3Services[service] = categoryData.level3Services[service];
                        }
                    }
                } else {
                    widgetState.additionalServices.delete(service);
                    // Remove Level 3 selections when deselecting
                    if (widgetState.additionalLevel3Services) {
                        delete widgetState.additionalLevel3Services[service];
                    }
                }
            }
            
            debugLog('Service selection updated', {
                type,
                service,
                category,
                hasLevel3,
                selected: element.classList.contains('selected')
            });
        }

        // Open Level 3 services modal
        function openLevel3Modal(service, category, context) {
            const modal = document.getElementById('level3Modal');
            const container = document.getElementById('level3ServicesContainer');
            container.innerHTML = '';
            
            const categoryData = SERVICE_CATEGORIES[category];
            const level3Services = categoryData.level3Services ? categoryData.level3Services[service] : null;
            
            if (!level3Services || level3Services.length === 0) return;
            
            // Store context for saving
            if (!widgetState.currentLevel3Context) {
                widgetState.currentLevel3Context = {};
            }
            widgetState.currentLevel3Context = {
                service: service,
                category: category,
                context: context
            };
            
            // Set modal title
            document.getElementById('level3ModalTitle').textContent = `Select Specific Services for ${service}`;
            
            // Create checkbox list
            const list = document.createElement('div');
            list.className = 'level3-service-list';
            
            // Get previously selected services if any
            const previouslySelected = context === 'primary' 
                ? (widgetState.primaryLevel3Services && widgetState.primaryLevel3Services[service]) || []
                : (widgetState.additionalLevel3Services && widgetState.additionalLevel3Services[service]) || [];
            
            level3Services.forEach(l3Service => {
                const item = document.createElement('div');
                item.className = 'level3-service-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `l3_${l3Service.replace(/\s+/g, '_')}`;
                checkbox.value = l3Service;
                // Default to checked, unless previously deselected
                checkbox.checked = previouslySelected.length === 0 || previouslySelected.includes(l3Service);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = l3Service;
                
                item.appendChild(checkbox);
                item.appendChild(label);
                
                // Add click handler to entire item
                item.onclick = (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                };
                
                list.appendChild(item);
            });
            
            container.appendChild(list);
            modal.classList.add('active');
        }

        // Close Level 3 modal
        window.closeLevel3Modal = function() {
            const modal = document.getElementById('level3Modal');
            modal.classList.remove('active');
        }

        // Save Level 3 selections
        window.saveLevel3Services = function() {
            const context = widgetState.currentLevel3Context;
            if (!context) return;
            
            const checkboxes = document.querySelectorAll('#level3ServicesContainer input[type="checkbox"]:checked');
            const selectedServices = Array.from(checkboxes).map(cb => cb.value);
            
            // Initialize Level 3 services objects if they don't exist
            if (!widgetState.primaryLevel3Services) {
                widgetState.primaryLevel3Services = {};
            }
            if (!widgetState.additionalLevel3Services) {
                widgetState.additionalLevel3Services = {};
            }
            
            // Store the selections
            if (context.context === 'primary') {
                widgetState.primaryLevel3Services[context.service] = selectedServices;
            } else {
                widgetState.additionalLevel3Services[context.service] = selectedServices;
            }
            
            debugLog('Level 3 services saved', {
                service: context.service,
                category: context.category,
                context: context.context,
                selectedCount: selectedServices.length
            });
            
            // Update the badge count to reflect actual selected services
            const serviceElements = document.querySelectorAll(`.service-tag[data-service="${context.service}"]`);
            debugLog('Found service elements:', serviceElements.length);
            
            serviceElements.forEach(element => {
                const badge = element.querySelector('.service-count-badge');
                debugLog('Badge found:', badge);
                
                if (badge) {
                    // Update badge with actual selected count
                    badge.textContent = selectedServices.length;
                    debugLog('Updated badge text to:', selectedServices.length);
                    
                    // Hide badge if no services selected or only 1 (which would be the service itself)
                    if (selectedServices.length <= 1) {
                        badge.style.display = 'none';
                    } else {
                        badge.style.display = 'inline-block';
                    }
                } else {
                    // If no badge exists but should, create one
                    if (selectedServices.length > 1) {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'service-count-badge';
                        newBadge.textContent = selectedServices.length;
                        element.appendChild(newBadge);
                        debugLog('Created new badge with count:', selectedServices.length);
                    }
                }
            });
            
            window.closeLevel3Modal();
        }

        // Render additional categories
        function renderAdditionalCategories() {
            const container = document.getElementById('additional-categories-container');
            const excludePrimary = widgetState.primaryCategory;
            
            const availableCategories = Object.keys(SERVICE_CATEGORIES).filter(cat => cat !== excludePrimary);
            
            container.innerHTML = availableCategories.map(category => 
                `<div class="category-option" data-category="${category}">${category}</div>`
            ).join('');
        }

        // Handle additional category selection
        function handleAdditionalCategorySelection(element) {
            const category = element.dataset.category;
            const isCurrentlySelected = element.classList.contains('selected');
            
            debugLog('Category selection clicked:', {
                category,
                isCurrentlySelected,
                currentCount: widgetState.additionalCategories.size
            });
            
            if (isCurrentlySelected) {
                // Deselect the category
                element.classList.remove('selected');
                widgetState.additionalCategories.delete(category);
                debugLog('Category deselected:', category);
            } else {
                // Check if we're at the limit
                if (widgetState.additionalCategories.size >= 2) {
                    showMessage('error', 'You can only select up to 2 additional categories. Please deselect one first.');
                    return;
                }
                
                // Select the category
                element.classList.add('selected');
                widgetState.additionalCategories.add(category);
                debugLog('Category selected:', category);
            }
            
            // Force UI refresh to ensure visual state matches data state
            refreshCategorySelectionUI();
        }
        
        // Refresh category selection UI to match state
        function refreshCategorySelectionUI() {
            const categoryOptions = document.querySelectorAll('.category-option');
            categoryOptions.forEach(option => {
                const category = option.dataset.category;
                const shouldBeSelected = widgetState.additionalCategories.has(category);
                
                if (shouldBeSelected) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // Render additional services
        function renderAdditionalServices() {
            const container = document.getElementById('additional-services-container');
            const categories = Array.from(widgetState.additionalCategories);
            
            if (categories.length === 0) {
                container.innerHTML = '<p>No additional categories selected.</p>';
                return;
            }
            
            let html = '';
            categories.forEach(category => {
                const categoryData = SERVICE_CATEGORIES[category];
                let services = categoryData ? categoryData.subcategories : [];
                
                // Filter out redundant subcategories
                services = filterRedundantSubcategories(services, category);
                
                html += `<h4>${category}</h4>`;
                html += '<div class="services-container">';
                html += services.map(service => {
                    const level3Services = categoryData.level3Services && categoryData.level3Services[service];
                    const level3Count = level3Services ? level3Services.length : 0;
                    const hasLevel3 = level3Count > 0;
                    // Only show badge if there are MORE than 1 Level 3 service
                    const showBadge = level3Count > 1;
                    const badgeHtml = showBadge ? `<span class="service-count-badge">${level3Count}</span>` : '';
                    return `<span class="service-tag" data-category="${category}" data-service="${service}" data-type="additional" data-has-level3="${hasLevel3}" data-level3-count="${level3Count}">${service}${badgeHtml}</span>`;
                }).join('');
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Show slide 5 and prepare additional categories
        document.addEventListener('DOMContentLoaded', function() {
            // Add event to prepare slide 5 when navigating to it
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.target.id === 'slide-5' && mutation.target.classList.contains('active')) {
                        renderAdditionalCategories();
                    }
                    if (mutation.target.id === 'slide-6' && mutation.target.classList.contains('active')) {
                        renderAdditionalServices();
                    }
                });
            });
            
            document.querySelectorAll('.form-slide').forEach(slide => {
                observer.observe(slide, { attributes: true, attributeFilter: ['class'] });
            });
        });

        // Handle coverage type change
        function handleCoverageTypeChange(e) {
            const coverageType = e.target.value;
            widgetState.coverageType = coverageType;
            
            // Show coverage details section
            document.getElementById('coverage-details').style.display = coverageType ? 'block' : 'none';
            
            // Hide all coverage inputs
            document.getElementById('stateSelectionContainer').style.display = 'none';
            document.getElementById('countyInputGroup').style.display = 'none';
            document.getElementById('zipInputGroup').style.display = 'none';
            
            // Show appropriate input based on coverage type
            switch(coverageType) {
                case 'global':
                case 'national':
                    document.getElementById('service_coverage_area').value = 'All';
                    break;
                    
                case 'state':
                    document.getElementById('stateSelectionContainer').style.display = 'block';
                    updateStateCount();
                    break;
                    
                case 'county':
                    document.getElementById('countyInputGroup').style.display = 'block';
                    // Reset county state selector to ensure the state field shows properly
                    const countyStateSelector = document.getElementById('county_state_selector');
                    countyStateSelector.value = '';
                    // Hide county checkboxes until a state is selected
                    document.getElementById('county-checkboxes-container').style.display = 'none';
                    document.getElementById('county-loading').style.display = 'none';
                    document.getElementById('county-error').style.display = 'none';
                    break;
                    
                case 'zip':
                    document.getElementById('zipInputGroup').style.display = 'block';
                    break;
            }
        }

        // State selection functions
        window.selectAllStates = function() {
            document.querySelectorAll('#state-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateStateCount();
        }

        window.clearAllStates = function() {
            document.querySelectorAll('#state-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateStateCount();
        }

        window.updateStateCount = function() {
            const checkedCount = document.querySelectorAll('#state-checkboxes input[type="checkbox"]:checked').length;
            document.getElementById('state-count').textContent = `${checkedCount} selected`;
        }

        // Handle county state selection
        function handleCountyStateSelection(e) {
            const selectedState = e.target.value;
            debugLog('State selected for county lookup:', selectedState);
            
            // Clear any existing county data
            document.getElementById('county-checkboxes').innerHTML = '';
            document.getElementById('county-checkboxes-container').style.display = 'none';
            document.getElementById('county-loading').style.display = 'none';
            document.getElementById('county-error').style.display = 'none';
            
            if (selectedState) {
                // Small delay to ensure UI updates
                setTimeout(() => {
                    loadCountiesForState(selectedState);
                }, 100);
            } else {
                updateCountyCount();
            }
        }

        // Load counties for state
        async function loadCountiesForState(stateCode) {
            const loadingDiv = document.getElementById('county-loading');
            const containerDiv = document.getElementById('county-checkboxes-container');
            const errorDiv = document.getElementById('county-error');
            const checkboxesDiv = document.getElementById('county-checkboxes');
            
            debugLog('Starting county load for state:', stateCode);
            
            // Ensure all elements exist
            if (!loadingDiv || !containerDiv || !errorDiv || !checkboxesDiv) {
                debugLog('Error: County UI elements not found');
                return;
            }
            
            // Show loading state
            loadingDiv.style.display = 'block';
            containerDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            try {
                const apiUrl = 'https://dockside.life/api/v1/locations/states/' + stateCode + '/counties';
                // const apiUrl = 'http://localhost:8000/api/v1/locations/states/' + stateCode + '/counties'; // For local testing
                
                debugLog('Fetching counties from:', apiUrl);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-From': 'docksidepros.com'
                    },
                    credentials: 'omit', // Important for cross-domain requests
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                debugLog('Counties API response:', data);
                
                if (data.status === "success" && data.counties && Array.isArray(data.counties) && data.counties.length > 0) {
                    // Generate county checkboxes
                    const countiesHtml = data.counties.map(county => {
                        const cleanCountyName = String(county).trim();
                        const countyId = `county-${stateCode}-${cleanCountyName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        return `
                            <div class="checkbox-item">
                                <input type="checkbox" 
                                       id="${countyId}" 
                                       name="coverage_counties[]" 
                                       value="${cleanCountyName}, ${stateCode}"
                                       data-county="${cleanCountyName}"
                                       data-state="${stateCode}"
                                       onchange="updateCountyCount()">
                                <label for="${countyId}">${cleanCountyName}</label>
                            </div>
                        `;
                    }).join('');
                    
                    checkboxesDiv.innerHTML = countiesHtml;
                    
                    // Show the container
                    loadingDiv.style.display = 'none';
                    containerDiv.style.display = 'block';
                    
                    updateCountyCount();
                    debugLog('Counties successfully loaded and displayed');
                } else {
                    throw new Error('Invalid response format or no counties found');
                }
            } catch (error) {
                console.error('Error loading counties:', error);
                debugLog('County loading error:', {
                    message: error.message,
                    stateCode: stateCode
                });
                
                // Show error state with fallback
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                
                // Create fallback textarea
                const fallbackHtml = `
                    <div style="margin: 0 -10px;">
                        <label for="coverage_counties_fallback" style="display: block; margin-bottom: 8px; font-weight: 500;">
                            Enter counties manually (one per line or comma-separated):
                        </label>
                        <textarea id="coverage_counties_fallback" 
                                  name="coverage_counties" 
                                  rows="4" 
                                  placeholder="Enter county names for ${stateCode} (e.g., Miami-Dade, Broward, Palm Beach)"
                                  style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; font-family: inherit;"></textarea>
                    </div>
                `;
                
                checkboxesDiv.innerHTML = fallbackHtml;
                containerDiv.style.display = 'block';
                
                debugLog('Fallback textarea created for county input');
            }
        }

        // Update county count
        window.updateCountyCount = function() {
            const checkedCount = document.querySelectorAll('#county-checkboxes input[type="checkbox"]:checked').length;
            document.getElementById('county-count').textContent = `${checkedCount} counties selected`;
        }

        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Validate final slide
            if (!validateCurrentSlide(8)) {
                return;
            }
            
            // Check consent
            const smsConsent = document.getElementById('sms_consent');
            if (!smsConsent.checked) {
                showMessage('error', 'Please agree to receive communications from DocksidePros.com');
                return;
            }
            
            // Collect form data
            const formData = new FormData(e.target);
            const payload = {};
            
            // Basic fields with sanitization
            formData.forEach((value, key) => {
                if (key !== 'coverage_counties[]') {
                    // Sanitize text inputs for security
                    if (typeof value === 'string') {
                        payload[key] = validateTextInput(value, 500);
                    } else {
                        payload[key] = value;
                    }
                }
            });
            
            // Add coverage data
            const coverageType = document.getElementById('coverage_type').value;
            payload.coverage_type = coverageType;
            
            switch(coverageType) {
                case 'global':
                case 'national':
                    payload.service_coverage_area = 'All';
                    break;
                    
                case 'state':
                    const selectedStates = Array.from(document.querySelectorAll('#state-checkboxes input[type="checkbox"]:checked'))
                        .map(cb => cb.value);
                    payload.coverage_states = selectedStates;
                    payload.service_coverage_area = selectedStates.join(', ');
                    break;
                    
                case 'county':
                    let countyList = [];
                    const selectedCountyCheckboxes = document.querySelectorAll('#county-checkboxes input[type="checkbox"]:checked');
                    
                    if (selectedCountyCheckboxes.length > 0) {
                        countyList = Array.from(selectedCountyCheckboxes).map(cb => cb.value);
                    } else {
                        const fallbackTextarea = document.getElementById('coverage_counties_fallback');
                        if (fallbackTextarea && fallbackTextarea.value.trim()) {
                            const stateCode = document.getElementById('county_state_selector').value;
                            const counties = fallbackTextarea.value.split(',').map(c => c.trim()).filter(c => c);
                            countyList = counties.map(county => `${county}, ${stateCode}`);
                        }
                    }
                    
                    payload.coverage_counties = countyList;
                    payload.service_coverage_area = countyList.join('; ');
                    break;
                    
                case 'zip':
                    const zipCodes = document.getElementById('service_zip_codes').value
                        .split(',')
                        .map(zip => zip.trim())
                        .filter(zip => zip.length > 0);
                    payload.service_zip_codes = zipCodes.join(',');
                    payload.service_coverage_area = payload.service_zip_codes;
                    break;
            }
            
            // Add service data
            payload.primary_service_category = widgetState.primaryCategory;
            payload.primary_services = Array.from(widgetState.primaryServices).join(', ');
            payload.additional_categories = Array.from(widgetState.additionalCategories).join(', ');
            payload.additional_services = Array.from(widgetState.additionalServices).join(', ');
            
            // Add Level 3 services data
            payload.primary_level3_services = widgetState.primaryLevel3Services || {};
            payload.additional_level3_services = widgetState.additionalLevel3Services || {};
            
            // Combined fields for backward compatibility
            const allCategories = [widgetState.primaryCategory, ...Array.from(widgetState.additionalCategories)].filter(c => c);
            payload.service_categories = allCategories.join(', ');
            
            const allServices = [...Array.from(widgetState.primaryServices), ...Array.from(widgetState.additionalServices)];
            payload.services_provided = allServices.join(', ');
            
            // Combine all Level 3 services for a comprehensive list
            const allLevel3Services = {};
            Object.assign(allLevel3Services, widgetState.primaryLevel3Services || {});
            Object.assign(allLevel3Services, widgetState.additionalLevel3Services || {});
            payload.all_level3_services = allLevel3Services;
            
            // Add consent flags
            payload.sms_consent = document.getElementById('sms_consent').checked;
            payload.marketing_consent = document.getElementById('marketing_consent').checked;
            
            // Custom attribute: identify submission as vendor application
            payload.user_type = 'vendor';
            
            // Ensure years_in_business is included even if empty
            payload.years_in_business = document.getElementById('years_in_business').value || '';
            
            // Ensure service_zip_codes is properly formatted for vendor applications
            if (!payload.service_zip_codes && payload.service_coverage_area) {
                payload.service_zip_codes = payload.service_coverage_area;
            }
            
            // Show loading state
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.classList.add('loading');
            submitButton.textContent = '';
            
            debugLog('Submitting payload:', payload);
            
            try {
                const apiUrl = 'https://dockside.life/api/v1/webhooks/elementor/vendor_application';
                // const apiUrl = 'http://localhost:8000/api/v1/webhooks/elementor/vendor_application'; // For local testing
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-From': 'docksidepros.com'
                    },
                    credentials: 'omit', // Important for cross-domain requests
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    debugLog('Response data:', result);
                    
                    // Clear draft
                    clearDraft();
                    
                    // Show thank you page
                    showThankYouPage();
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('error', 'There was an error submitting your application. Please try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.classList.remove('loading');
                submitButton.textContent = 'Get in Touch';
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('vendorSurveyForm').reset();
            
            // Reset state
            widgetState.primaryCategory = '';
            widgetState.primaryServices.clear();
            widgetState.primaryLevel3Services = {};
            widgetState.additionalCategories.clear();
            widgetState.additionalServices.clear();
            widgetState.additionalLevel3Services = {};
            widgetState.currentLevel3Context = null;
            widgetState.currentSlide = 1;
            widgetState.coverageType = '';
            
            // Show first slide
            document.querySelectorAll('.form-slide').forEach((slide, index) => {
                slide.classList.toggle('active', index === 0);
            });
            
            // Reset UI
            document.getElementById('primary-services-section').style.display = 'none';
            document.getElementById('coverage-details').style.display = 'none';
            
            updateProgress();
        }

        // Save draft
        function saveDraft() {
            const formData = {};
            const form = document.getElementById('vendorSurveyForm');
            
            // Save form inputs
            Array.from(form.elements).forEach(element => {
                if (element.name && element.type !== 'submit') {
                    formData[element.name] = element.value;
                }
            });
            
            // Save state
            const draft = {
                formData,
                primaryCategory: widgetState.primaryCategory,
                primaryServices: Array.from(widgetState.primaryServices),
                primaryLevel3Services: widgetState.primaryLevel3Services,
                additionalCategories: Array.from(widgetState.additionalCategories),
                additionalServices: Array.from(widgetState.additionalServices),
                additionalLevel3Services: widgetState.additionalLevel3Services,
                currentSlide: widgetState.currentSlide,
                coverageType: widgetState.coverageType,
                timestamp: new Date().toISOString()
            };
            
            // Disabled localStorage to ensure form is empty on each load
            // localStorage.setItem('vendorSurveyDraft', JSON.stringify(draft));
        }

        // Load draft
        function loadDraft() {
            const draftStr = localStorage.getItem('vendorSurveyDraft');
            if (!draftStr) return;
            
            try {
                const draft = JSON.parse(draftStr);
                
                // Restore form data
                Object.entries(draft.formData).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                    }
                });
                
                // Restore state
                widgetState.primaryCategory = draft.primaryCategory || '';
                widgetState.primaryServices = new Set(draft.primaryServices || []);
                widgetState.primaryLevel3Services = draft.primaryLevel3Services || {};
                widgetState.additionalCategories = new Set(draft.additionalCategories || []);
                widgetState.additionalServices = new Set(draft.additionalServices || []);
                widgetState.additionalLevel3Services = draft.additionalLevel3Services || {};
                widgetState.coverageType = draft.coverageType || '';
                
                // Restore UI state
                if (widgetState.primaryCategory) {
                    handlePrimaryCategorySelection({ target: { value: widgetState.primaryCategory } });
                    
                    // Restore selected services
                    widgetState.primaryServices.forEach(service => {
                        const serviceTag = document.querySelector(`[data-service="${service}"][data-type="primary"]`);
                        if (serviceTag) serviceTag.classList.add('selected');
                    });
                }
                
                debugLog('Draft loaded successfully');
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }

        // Clear draft
        function clearDraft() {
            // Clear any existing draft on page load
            localStorage.removeItem('vendorSurveyDraft');
        }
        
        // Clear draft on every page load to ensure empty form
        clearDraft();

        // Show thank you page
        function showThankYouPage() {
            // Hide all slides
            document.querySelectorAll('.form-slide').forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Show thank you slide
            const thankYouSlide = document.getElementById('slide-9');
            thankYouSlide.classList.add('active');
            
            // Update progress to 100%
            widgetState.currentSlide = 9;
            updateProgress();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Start new application
        window.startNewApplication = function() {
            // Reset the form
            resetForm();
            
            // Go back to first slide
            document.querySelectorAll('.form-slide').forEach(slide => {
                slide.classList.remove('active');
            });
            document.getElementById('slide-1').classList.add('active');
            
            widgetState.currentSlide = 1;
            updateProgress();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Clear field errors
        function clearFieldErrors() {
            // Clear all field error messages
            document.querySelectorAll('.field-error').forEach(error => {
                error.textContent = '';
            });
            
            // Remove has-error classes from form groups
            document.querySelectorAll('.form-group.has-error').forEach(group => {
                group.classList.remove('has-error');
            });
        }

        // Clear temporary UI state
        function clearTemporaryUIState() {
            // Clear any error messages
            document.querySelectorAll('.message').forEach(msg => {
                msg.classList.remove('show');
            });
            
            // Use the clearFieldErrors function
            clearFieldErrors();
        }
        
        // Clear form data from subsequent slides when going back
        function clearSubsequentFormData(currentSlideNum) {
            debugLog(`Clearing subsequent form data from slide ${currentSlideNum}`);
            
            // If going back from any slide, clear data from current slide onwards
            switch(currentSlideNum) {
                case 4: // Going back from primary category - clear everything after
                    widgetState.primaryCategory = '';
                    widgetState.primaryServices.clear();
                    // Reset the select element to default option
                    const primaryCategorySelect = document.getElementById('primary_service_category');
                    if (primaryCategorySelect) {
                        primaryCategorySelect.value = '';
                    }
                    // Hide the services section
                    const primaryServicesSection = document.getElementById('primary-services-section');
                    if (primaryServicesSection) {
                        primaryServicesSection.style.display = 'none';
                    }
                    // Clear the services container
                    const servicesContainer = document.getElementById('primary-services-container');
                    if (servicesContainer) {
                        servicesContainer.innerHTML = '';
                    }
                    // Fall through to clear additional data
                case 5: // Going back from additional categories
                    widgetState.additionalCategories.clear();
                    widgetState.additionalServices.clear();
                    // Fall through to clear coverage data
                case 6: // Going back from additional services
                case 7: // Going back from coverage area
                    // Clear coverage area selections
                    widgetState.coverageType = '';
                    widgetState.selectedStates.clear();
                    widgetState.selectedCounties.clear();
                    widgetState.selectedZipCodes = '';
                    // Clear form fields
                    const coverageSelect = document.getElementById('coverage_type');
                    if (coverageSelect) coverageSelect.value = '';
                    const zipInput = document.getElementById('service_zip_codes');
                    if (zipInput) zipInput.value = '';
                    clearStateCountySelections();
                    // Fall through to clear final details
                case 8: // Going back from final details
                    // Clear final detail fields
                    const yearsField = document.getElementById('years_in_business');
                    const contactField = document.getElementById('contact_preference');
                    const websiteField = document.getElementById('website_url');
                    const additionalWebsiteField = document.getElementById('additional_website_url');
                    const notesField = document.getElementById('additional_notes');
                    
                    if (yearsField) yearsField.value = '';
                    if (contactField) contactField.value = '';
                    if (websiteField) websiteField.value = '';
                    if (additionalWebsiteField) additionalWebsiteField.value = '';
                    if (notesField) notesField.value = '';
                    break;
            }
            
            // Clear visual selections on current slide
            clearSlideVisualSelections(currentSlideNum);
        }
        
        // Clear visual selections for a specific slide
        function clearSlideVisualSelections(slideNum) {
            const slide = document.getElementById(`slide-${slideNum}`);
            if (!slide) return;
            
            // Clear selected category/service tags
            slide.querySelectorAll('.service-tag.selected, .category-option.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Clear checked checkboxes
            slide.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
            });
            
            // Clear radio button selections
            slide.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                radio.checked = false;
            });
        }
        
        // Clear state and county selections
        function clearStateCountySelections() {
            document.querySelectorAll('#stateSelectionGroup input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
            });
            document.querySelectorAll('#countyInputGroup input[type="checkbox"]:checked').forEach(cb => {
                cb.checked = false;
            });
            
            // Hide county section
            const countySection = document.getElementById('countyInputGroup');
            if (countySection) {
                countySection.style.display = 'none';
            }
        }

        // Refresh slide-specific UI state
        function refreshSlideUIState(slideNum) {
            debugLog('Refreshing UI state for slide:', slideNum);
            
            switch(slideNum) {
                case 4: // Primary category slide
                    const primaryCategorySelect = document.getElementById('primary_service_category');
                    if (widgetState.primaryCategory) {
                        // Ensure dropdown shows the correct value
                        if (primaryCategorySelect) {
                            primaryCategorySelect.value = widgetState.primaryCategory;
                        }
                        // Re-render primary services to ensure UI matches state
                        renderPrimaryServices(widgetState.primaryCategory);
                        document.getElementById('primary-services-section').style.display = 'block';
                        
                        // Restore selected services
                        setTimeout(() => {
                            widgetState.primaryServices.forEach(service => {
                                const serviceTag = document.querySelector(`[data-service="${service}"][data-type="primary"]`);
                                if (serviceTag) serviceTag.classList.add('selected');
                            });
                        }, 50);
                    } else {
                        // No primary category selected - ensure UI is reset
                        if (primaryCategorySelect) {
                            primaryCategorySelect.value = '';
                        }
                        const servicesSection = document.getElementById('primary-services-section');
                        if (servicesSection) {
                            servicesSection.style.display = 'none';
                        }
                        const servicesContainer = document.getElementById('primary-services-container');
                        if (servicesContainer) {
                            servicesContainer.innerHTML = '';
                        }
                    }
                    break;
                    
                case 5: // Additional categories slide
                    renderAdditionalCategories();
                    // Restore category selections
                    setTimeout(() => {
                        refreshCategorySelectionUI();
                    }, 50);
                    break;
                    
                case 6: // Additional services slide
                    renderAdditionalServices();
                    // Restore service selections
                    setTimeout(() => {
                        widgetState.additionalServices.forEach(service => {
                            const serviceTag = document.querySelector(`[data-service="${service}"][data-type="additional"]`);
                            if (serviceTag) serviceTag.classList.add('selected');
                        });
                    }, 50);
                    break;
                    
                case 7: // Coverage area slide
                    // Reset coverage area UI state
                    if (widgetState.coverageType) {
                        const coverageSelect = document.getElementById('coverage_type');
                        coverageSelect.value = widgetState.coverageType;
                        handleCoverageTypeChange({ target: coverageSelect });
                    }
                    break;
            }
        }

        // Setup input formatting and real-time validation
        function setupInputFormatting() {
            // Phone number formatting
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 6) {
                    value = `(${value.substring(0,3)}) ${value.substring(3,6)}-${value.substring(6,10)}`;
                } else if (value.length >= 3) {
                    value = `(${value.substring(0,3)}) ${value.substring(3)}`;
                }
                e.target.value = value;
            });

            // Zip code formatting
            const zipInput = document.getElementById('postalCode');
            zipInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = `${value.substring(0,5)}-${value.substring(5,9)}`;
                }
                e.target.value = value;
            });

            // Personal name field validation (letters, spaces, hyphens, periods only)
            const personalNameFields = ['firstName', 'lastName'];
            personalNameFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function(e) {
                        // Allow letters, spaces, hyphens, periods, apostrophes
                        const value = e.target.value.replace(/[^a-zA-Z\s\-\.']/g, '');
                        e.target.value = value;
                    });
                }
            });
            
            // Company name validation - allow numbers and special characters
            const companyNameField = document.getElementById('vendor_company_name');
            if (companyNameField) {
                companyNameField.addEventListener('input', function(e) {
                    // Allow letters, numbers, spaces, and common business characters
                    // This includes: &, /, #, -, ., ', (, ), !
                    const value = e.target.value.replace(/[^a-zA-Z0-9\s\-\.,'&/#()!]/g, '');
                    e.target.value = value;
                });
            }

            // City field validation (letters, spaces, hyphens, periods only)
            const cityField = document.getElementById('city');
            cityField.addEventListener('input', function(e) {
                const value = e.target.value.replace(/[^a-zA-Z\s\-\.]/g, '');
                e.target.value = value;
            });
            
            // Street address field validation
            const addressField = document.getElementById('address1');
            if (addressField) {
                addressField.addEventListener('input', function(e) {
                    // Allow alphanumeric, spaces, and common address characters
                    const value = e.target.value.replace(/[^a-zA-Z0-9\s\-\.,'#]/g, '');
                    if (value.length <= 100) {
                        e.target.value = value;
                    } else {
                        e.target.value = value.substring(0, 100);
                    }
                });
            }

            // URL field auto-correction
            const urlFields = ['website_url', 'reviews__google_profile_url'];
            urlFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function(e) {
                        let value = e.target.value.trim();
                        if (value && !value.match(/^https?:\/\//i)) {
                            // Add https:// if no protocol is present
                            if (value.startsWith('www.')) {
                                value = 'https://' + value;
                            } else {
                                value = 'https://' + value;
                            }
                            e.target.value = value;
                        }
                    });
                }
            });

            // Real-time validation feedback
            const validatedFields = ['phone', 'postalCode', 'email', 'website_url', 'reviews__google_profile_url'];
            validatedFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        validateSingleField(fieldId);
                    });
                }
            });
            
            // Add character limit to textarea
            const notesField = document.getElementById('special_requests__notes');
            if (notesField) {
                notesField.addEventListener('input', function(e) {
                    if (e.target.value.length > 500) {
                        e.target.value = e.target.value.substring(0, 500);
                    }
                });
            }
            
            // Add validation for years in business
            const yearsField = document.getElementById('years_in_business');
            if (yearsField) {
                yearsField.addEventListener('input', function(e) {
                    const value = parseInt(e.target.value);
                    if (e.target.value && (isNaN(value) || value < 0 || value > 100)) {
                        e.target.value = Math.max(0, Math.min(100, value || 0));
                    }
                });
            }
        }

        // Single field validation
        function validateSingleField(fieldId) {
            const field = document.getElementById(fieldId);
            const value = field.value.trim();
            let isValid = true;
            let message = '';

            switch(fieldId) {
                case 'phone':
                    const phoneDigits = value.replace(/\D/g, '');
                    if (value && phoneDigits.length !== 10) {
                        isValid = false;
                        message = 'Please enter a 10-digit phone number';
                    }
                    break;
                case 'postalCode':
                    if (value && !/^\d{5}(-\d{4})?$/.test(value)) {
                        isValid = false;
                        message = 'Please enter a valid zip code (##### or #####-####)';
                    }
                    break;
                case 'email':
                    if (value && !isValidEmail(value)) {
                        isValid = false;
                        message = 'Please enter a valid email address';
                    }
                    break;
                case 'website_url':
                case 'reviews__google_profile_url':
                    if (value) {
                        // Strict URL validation with proper TLD requirement
                        const urlPattern = /^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z]{2,}(\.[a-zA-Z]{2,})*\b([-a-zA-Z0-9()@:%_\+.~#?&\/\/=]*)$/;
                        if (!urlPattern.test(value)) {
                            isValid = false;
                            message = 'Please submit valid Link / URL';
                        } else {
                            // Additional check for common invalid patterns
                            const domain = value.replace(/^https?:\/\/(www\.)?/, '').split('/')[0];
                            if (domain.split('.').length < 2 || domain.split('.').some(part => part.length === 0)) {
                                isValid = false;
                                message = 'Please submit valid Link / URL';
                            }
                        }
                    }
                    break;
            }

            const errorSpan = field.parentNode.querySelector('.field-error');
            if (errorSpan) {
                errorSpan.textContent = isValid ? '' : message;
                field.parentNode.classList.toggle('has-error', !isValid);
            }
        }

        // Clear form from current slide onwards
        window.clearCurrentSlideAndAfter = function() {
            const currentSlide = widgetState.currentSlide;
            
            if (confirm('This will clear all information from this step onwards. Are you sure?')) {
                debugLog(`Clearing form from slide ${currentSlide} onwards`);
                
                // Use the same logic as going back but for current slide
                clearSubsequentFormData(currentSlide);
                
                // Refresh the current slide UI
                refreshSlideUIState(currentSlide);
                
                // Show success message
                showMessage('success', 'Form cleared successfully! You can start fresh from this step.');
            }
        }

        // Initialize when DOM is ready
        function initWidget() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeWidget);
            } else {
                // Small delay to ensure WordPress has finished loading
                setTimeout(initializeWidget, 100);
            }
        }
        
        // WordPress compatibility - handle both jQuery and no-jQuery scenarios
        if (typeof jQuery !== 'undefined') {
            jQuery(document).ready(initWidget);
        } else {
            initWidget();
        }
        
    })(window.jQuery || window.$ || function(){});
    
    // ===== IFRAME AUTO-RESIZE FUNCTIONALITY =====
    (function () {
        // Unique channel for this widget
        const WIDGET_ID = 'vendor-widget';
        
        function postHeight() {
            const height = document.documentElement.scrollHeight || document.body.scrollHeight;
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(
                    { 
                        type: 'vendorWidget:height', 
                        widgetId: WIDGET_ID, 
                        height: height 
                    },
                    '*'
                );
            }
        }
        
        // Use ResizeObserver to watch for content changes
        if (window.ResizeObserver) {
            const ro = new ResizeObserver(() => {
                postHeight();
            });
            ro.observe(document.documentElement);
            ro.observe(document.body);
        }
        
        // Send height on key lifecycle moments
        window.addEventListener('load', postHeight);
        window.addEventListener('resize', postHeight);
        
        // Hook into slide navigation functions
        const originalNextSlide = window.nextSlide;
        const originalPrevSlide = window.prevSlide;
        
        if (originalNextSlide) {
            window.nextSlide = function(n) {
                const result = originalNextSlide.call(this, n);
                setTimeout(postHeight, 100);
                return result;
            };
        }
        
        if (originalPrevSlide) {
            window.prevSlide = function(n) {
                const result = originalPrevSlide.call(this, n);
                setTimeout(postHeight, 100);
                return result;
            };
        }
        
        // Send height after dynamic content changes
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(postHeight, 50);
        });
        
        // Also send height when form sections are shown/hidden
        const observer = new MutationObserver(() => {
            setTimeout(postHeight, 50);
        });
        
        // Observe changes to form slides
        const slidesContainer = document.querySelector('.modal-content');
        if (slidesContainer) {
            observer.observe(slidesContainer, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['style', 'class']
            });
        }
    })();
    </script>
</body>
</html>
