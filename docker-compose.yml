services:
  # Main API application
  api:
    container_name: dsp-api
    build: . 
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=sqlite:///./data/smart_lead_router.db
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENVIRONMENT=production
      - TENANT_DOMAIN=${DEFAULT_TENANT_DOMAIN}
      - TENANT_NOTIFICATION_EMAIL=${TENANT_NOTIFICATION_EMAIL}
    depends_on:
      - redis
    volumes:
      - .:/app
      - sqlite_data:/app/data
    networks: 
      - app-network
    command: ["uvicorn", "main_working_final:app", "--host", "0.0.0.0", "--port", "8000"]

  # SQLite database (via volume mount)
  # Note: SQLite doesn't need a separate container, we use volume mounts
  # The database file will be stored in the sqlite_data volume

  # Redis for caching and sessions
  redis:
    container_name: dsp-redis
    image: redis:7-alpine 
    ports:
      - "6380:6379"
    volumes: 
      - redis_data:/data 
    networks: 
      - app-network

  # Legacy Flask webhook server (deprecated - webhooks now handled by main API)
  # flask-webhook:
  #   build: . 
  #   container_name: dsp-flask-webhook
  #   ports:
  #     - "127.0.0.1:3000:3000"
  #   environment:
  #     - GHL_PRIVATE_TOKEN=${GHL_PRIVATE_TOKEN}
  #     - GHL_LOCATION_ID=${GHL_LOCATION_ID}
  #   command: ["python", "webhook_server.py"]
  #   volumes: 
  #     - uploads_data:/app/uploads 
  #     - logs_data:/app/logs 
  #     - sqlite_data:/app/data
  #   networks: 
  #     - app-network

  # Database backup service (optional)
  db-backup:
    container_name: dsp-backup
    image: alpine:latest
    volumes:
      - sqlite_data:/data
      - ./backups:/backups
    command: |
      sh -c "
      while true; do
        echo 'Creating backup...'
        cp /data/smart_lead_router.db /backups/smart_lead_router_$(date +%Y%m%d_%H%M%S).db
        echo 'Backup completed'
        sleep 86400
      done
      "
    restart: unless-stopped
    
networks: 
  app-network: 
    driver: bridge

volumes: 
  sqlite_data:
    driver: local
  redis_data: 
    driver: local
  uploads_data: 
    driver: local
  logs_data:
    driver: local
